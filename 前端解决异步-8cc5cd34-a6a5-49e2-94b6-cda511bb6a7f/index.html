
        <!DOCTYPE html>
         <html lang="en">
         <head>
	     <meta charset="UTF-8">
         <meta name="keywords" content="前端解决异步,博客,前端"/>
         <meta name="description" content="解决异步的一些方案以及个人见解"/>
         <!--<meta http-equiv="content-security-policy" content="default-src self"/>-->
	     <title>前端解决异步</title>
        </head>
        <link rel="stylesheet" href="../main.css">
        <body>
        <div class="message_box"></div>
        <div class="content">
           <div id="view">
              <div>
                <div class="bs_content">
                   <h2 id='前端异步的一些解决方案' class='Nb087520'>前端异步的一些解决方案</h2><h3 id='Promise' class='HL615410'>Promise</h3><h4 id='简介' class='Mh025111'>简介</h4><div><div class='quote'>Promise是Ecmascript2015年新增的api，作用是解决传统回调函数导致的回调地狱问题，它是一个异步编程的解决方案。</div></div><h4 id='简单使用' class='ZC032730'>简单使用</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div><div class='index'>29.</div><div class='index'>30.</div><div class='index'>31.</div><div class='index'>32.</div><div class='index'>33.</div><div class='index'>34.</div><div class='index'>35.</div><div class='index'>36.</div><div class='index'>37.</div><div class='index'>38.</div><div class='index'>39.</div><div class='index'>40.</div><div class='index'>41.</div><div class='index'>42.</div><div class='index'>43.</div></div><div class="codePre"><code data-key='xmp'><span class="green">//首先Promise有三个状态,分别为Pending,Rejected,Fulfilled</span></code><code data-key='xmp'><span class="green">//另外Promise不能终止执行,不能得到它执行到哪一个阶段,这可能是一大缺陷</span></code><code data-key='xmp'><span class="green">//它只能是Pending状态向另外两个状态过渡,不能是另外两个状态相互过度,过度完成就不能逆转</span></code><code data-key='xmp'><span class="green">//这个过度只能发生一次</span></code><code data-key='xmp'>//<span class="let"> Promise</span>是一个对象,它一般的方法需要实例才能使用,当然它身上也有挺多静态方法</code><code data-key='xmp'><span class="green">//所以它使用时是传一个回调函数在里面，回调函数有两个参数，分别是两个方法</span></code><code data-key='xmp'><span class="green">//一个是成功的时候调用，一个是失败的时候调用</span></code><code data-key='xmp'><span class="green">//是成功还是失败取决于你自己</span></code><code data-key='xmp'><span class="green">//当异步方法执行完根据返回的结果判断是否是预期的值时给与成功或者失败,如果不给，那它就一直是Pending状态,不能往下面继续执行了</span></code><code data-key='xmp'><span class="green">//实例完成后，Promise会返回一个实例对象，这个对象身上含有一个then，我们可以通过then来获取成功或者失败的结果</span></code><code data-key='xmp'><span class="green">//then方法里面传两个方法，正好对应了之前实例的两个，所以执行resolve和reject相当于执行这两个方法，如果是reject，还可以通过catch来接收失败返回的结果</span></code><code data-key='xmp'><span class="green">//如果失败前面已经处理过了，就不会再走catch</span></code><code data-key='xmp'><span class="green">//在then里面的两个方法里面返回一个值，后面继续用then接收得到的就是返回的结果值</span></code><code data-key='xmp'><span class="green">//把在这个题做对就说明已经懂我说的了</span></code><code data-key='xmp'><span class="let">new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  <span class="green">//在这里进行异步编程</span></code><code data-key='xmp'>  <span class="title">setTimeout<span class="log">(</span></span><span class='let'>function</span><span class="log">(</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="title">resolve<span class="log">(</span></span><span class="string">"fulfilled"</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span>,0<span class="log">)</span>;</code><code data-key='xmp'>  <span class="title">reject<span class="log">(</span></span><span class="string">"reject"</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>res<span class="log">)</span>;</code><code data-key='xmp'>  <span class="let">return</span> <span class="string">"成功了"</span>;</code><code data-key='xmp'><span class="log">}</span>,err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>err<span class="log">)</span>;</code><code data-key='xmp'>  <span class="let">return</span> <span class="string">"失败了"</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">.</span><span class="title1">catch</span><span class="log">(</span>err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>err<span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>res<span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>res<span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="green">//结果?</span></code><code data-key='xmp'><span class="green">//首先推算一下</span></code><code data-key='xmp'>//<span class="let"> Promise</span>其实是一个同步的方法，只不过后面的then和catch等方法是异步的，所以Promise里面的代码还是会执行</code><code data-key='xmp'><span class="green">//然后setTimeout<span class="log">(</span><span class='let'>function</span><span class="log">(</span><span class="log">)</span><span class="log">{</span><span class="log">}</span>,0<span class="log">)</span>这个东西懂事件总线的朋友们可能就知道,会执行reject<span class="log">(</span></span><span class="string">"reject"</span><span class="log">)</span>了,不多说了，不然说不完了</code><code data-key='xmp'><span class="green">//然后是会到then里面执行失败的回调方法打印</span><span class="string">"err"</span> 这个err是reject传过来的，所以第一个打印是 <span class="string">"reject"</span></code><code data-key='xmp'><span class="green">//后面又返回了一个</span><span class="string">"失败了"</span>的字符串，那后面应该执行哪个方法尼</code><code data-key='xmp'><span class="green">//注意前面reject的这个错误已经有人处理了，所以已经没有错了，所以catch是不会走的,会走第二个then,第二个then的res是之前第一个then返回的结果所以第二个打印 </span><span class="string">"失败了"</span></code><code data-key='xmp'><span class="green">//然后还是没有错继续走第三个then,有人会觉得第二个then没有返回结果，那第三个then的res是吗尼,注意函数会默认返回一个<span class='keyword'>undefined</span>，所以第三次打印是<span class='keyword'>undefined</span></span></code><code data-key='xmp'>  </code><code data-key='xmp'><span class="green">//答案: 所以总共三次打印，分别是 </span><span class="string">"reject"</span> <span class="string">"失败了"</span> <span class="string">"undefined"</span></code></div></pre><h3 id='Promise源码和注解' class='af624062'>Promise源码和注解</h3><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div><div class='index'>29.</div><div class='index'>30.</div><div class='index'>31.</div><div class='index'>32.</div><div class='index'>33.</div><div class='index'>34.</div><div class='index'>35.</div><div class='index'>36.</div><div class='index'>37.</div><div class='index'>38.</div><div class='index'>39.</div><div class='index'>40.</div><div class='index'>41.</div><div class='index'>42.</div><div class='index'>43.</div><div class='index'>44.</div><div class='index'>45.</div><div class='index'>46.</div><div class='index'>47.</div><div class='index'>48.</div><div class='index'>49.</div><div class='index'>50.</div><div class='index'>51.</div><div class='index'>52.</div><div class='index'>53.</div><div class='index'>54.</div><div class='index'>55.</div><div class='index'>56.</div><div class='index'>57.</div><div class='index'>58.</div><div class='index'>59.</div><div class='index'>60.</div><div class='index'>61.</div><div class='index'>62.</div><div class='index'>63.</div><div class='index'>64.</div><div class='index'>65.</div><div class='index'>66.</div><div class='index'>67.</div><div class='index'>68.</div><div class='index'>69.</div><div class='index'>70.</div><div class='index'>71.</div><div class='index'>72.</div><div class='index'>73.</div><div class='index'>74.</div><div class='index'>75.</div><div class='index'>76.</div><div class='index'>77.</div><div class='index'>78.</div><div class='index'>79.</div><div class='index'>80.</div><div class='index'>81.</div><div class='index'>82.</div><div class='index'>83.</div><div class='index'>84.</div><div class='index'>85.</div><div class='index'>86.</div><div class='index'>87.</div><div class='index'>88.</div><div class='index'>89.</div><div class='index'>90.</div><div class='index'>91.</div><div class='index'>92.</div><div class='index'>93.</div><div class='index'>94.</div><div class='index'>95.</div><div class='index'>96.</div><div class='index'>97.</div><div class='index'>98.</div><div class='index'>99.</div><div class='index'>100.</div><div class='index'>101.</div><div class='index'>102.</div><div class='index'>103.</div><div class='index'>104.</div><div class='index'>105.</div><div class='index'>106.</div><div class='index'>107.</div><div class='index'>108.</div><div class='index'>109.</div><div class='index'>110.</div><div class='index'>111.</div><div class='index'>112.</div><div class='index'>113.</div><div class='index'>114.</div><div class='index'>115.</div><div class='index'>116.</div><div class='index'>117.</div><div class='index'>118.</div><div class='index'>119.</div><div class='index'>120.</div><div class='index'>121.</div><div class='index'>122.</div><div class='index'>123.</div><div class='index'>124.</div><div class='index'>125.</div><div class='index'>126.</div><div class='index'>127.</div><div class='index'>128.</div><div class='index'>129.</div><div class='index'>130.</div><div class='index'>131.</div><div class='index'>132.</div><div class='index'>133.</div><div class='index'>134.</div><div class='index'>135.</div><div class='index'>136.</div><div class='index'>137.</div><div class='index'>138.</div><div class='index'>139.</div><div class='index'>140.</div><div class='index'>141.</div><div class='index'>142.</div><div class='index'>143.</div><div class='index'>144.</div><div class='index'>145.</div></div><div class="codePre"><code data-key='xmp'><span class="let">const </span>PENDING <span class="let">=</span> <span class="string">"PENDING"</span>,FULFILLED <span class="let">=</span> <span class="string">"FULFILLED"</span>,REJECTED <span class="let">=</span> <span class="string">"REJECTED"</span>;</code><code data-key='xmp'><span class="let">class </span>Promise<span class="log">{</span></code><code data-key='xmp'>  <span class="title"><span class="let">constructor</span><span class="log">(</span></span>callback<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> PENDING;</code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> <span class='keyword'>undefined</span>;</code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">onFulfilledQueues</span> <span class="let">=</span> [];</code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">onRejectedQueues</span> <span class="let">=</span> [];</code><code data-key='xmp'>    <span class="title">callback<span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">_resolve</span><span class="log">.</span><span class="title1">bind</span><span class="log">(</span>this<span class="log">)</span>,<span class="let">this</span><span class="log">.</span><span class="title1">_reject</span><span class="log">.</span><span class="title1">bind</span><span class="log">(</span>this<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">runFulfilledCallback<span class="log">(</span></span>value<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'><span class="let">    let </span>cb;</code><code data-key='xmp'>    <span class="title"><span class="let">while</span><span class="log">(</span></span>cb <span class="let">=</span> <span class="let">this</span><span class="log">.</span><span class="title1">onFulfilledQueues</span><span class="log">.</span><span class="title1">shift</span><span class="log">(</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="title">cb<span class="log">(</span></span>value<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">runRejectedCallback<span class="log">(</span></span>err<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'><span class="let">    let </span>cb;</code><code data-key='xmp'>    <span class="title"><span class="let">while</span><span class="log">(</span></span>cb <span class="let">=</span> <span class="let">this</span><span class="log">.</span><span class="title1">onRejectedQueues</span><span class="log">.</span><span class="title1">shift</span><span class="log">(</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="title">cb<span class="log">(</span></span>err<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">_resolve<span class="log">(</span></span>value<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">!</span><span class="let">==</span> PENDING<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">//三种状态必须是由 </span><span class="string">"PENDING"</span> 到 <span class="string">"FULFILLED"</span> 或者 <span class="string">"REJECTED"</span></code><code data-key='xmp'>      <span class="green">//所以只要状态不是 </span><span class="string">"PENDING"</span> 都表示已经结束了</code><code data-key='xmp'>       <span class="let">return</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>value<span class="let"> instanceof </span>Promise<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      // <span class="string">"value"</span>是一个 <span class="string">"MyPromise实例"</span></code><code data-key='xmp'>      <span class="green">//需要通过then再获取到value</span></code><code data-key='xmp'>      value<span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> FULFILLED;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> res;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">runFulfilledCallback</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span>,err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> REJECTED;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> err;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">runRejectedCallback</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> FULFILLED;</code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> value;</code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">runFulfilledCallback</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">_reject<span class="log">(</span></span>value<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">!</span><span class="let">==</span> PENDING<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">//和_resolve一样</span></code><code data-key='xmp'>       <span class="let">return</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>value<span class="let"> instanceof </span>Promise<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      value<span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> FULFILLED;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> res;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">runFulfilledCallback</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span>,err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> REJECTED;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> err;</code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">runRejectedCallback</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">_status</span> <span class="let">=</span> REJECTED;</code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">_value</span> <span class="let">=</span> value;</code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">runRejectedCallback</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">then<span class="log">(</span></span>onFulfilled,onRejected<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>onFulfilledNext,onRejectedNext<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'><span class="let">      const </span>fulfilled <span class="let">=</span> <span class="log">(</span>value<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>      <span class="title"><span class="let">if</span><span class="log">(</span></span><span class="let">typeof</span> onFulfilled <span class="let">!</span><span class="let">==</span> <span class="string">"function"</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        <span class="green">//then里面没有传递resolve执行的方法,自动向下传递到下一个then身上</span></code><code data-key='xmp'>        <span class="title">onFulFilledNext<span class="log">(</span></span>value<span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>        <span class="green">//有resolve方法,那就执行得到它里面的返回值传递至下一个then</span></code><code data-key='xmp'>        <span class="green">//但是还有一种可能就是返回值是一个Promise,我们需要执行拿到相应的值传递下去</span></code><code data-key='xmp'><span class="let">         let </span>retVal <span class="let">=</span> <span class="title">onFulfilled<span class="log">(</span></span>value<span class="log">)</span>;</code><code data-key='xmp'>         <span class="title"><span class="let">if</span><span class="log">(</span></span>retVal<span class="let"> instanceof </span>Promise<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>           retVal<span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="title">onFulfilledNext<span class="log">(</span></span>res<span class="log">)</span>,err<span class="log"> => </span><span class="title">onRejectedNext<span class="log">(</span></span>err<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>         <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>           <span class="title">onFulfilledNext<span class="log">(</span></span>retVal<span class="log">)</span>;</code><code data-key='xmp'>         <span class="log">}</span></code><code data-key='xmp'>      <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span>;</code><code data-key='xmp'><span class="let">    const </span>rejected <span class="let">=</span> <span class="log">(</span>value<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">//这个和fulfilled差不多</span></code><code data-key='xmp'>      <span class="title"><span class="let">if</span><span class="log">(</span></span><span class="let">typeof</span> onRejected <span class="let">!</span><span class="let">==</span> <span class="string">"function"</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        <span class="green">//传递给下一个then或者catch</span></code><code data-key='xmp'>        <span class="title">onRejectedNext<span class="log">(</span></span>value<span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'><span class="let">        let </span>retVal <span class="let">=</span> <span class="title">onRejected<span class="log">(</span></span>value<span class="log">)</span>;</code><code data-key='xmp'>        <span class="title"><span class="let">if</span><span class="log">(</span></span>retVal<span class="let"> instanceof </span>Promise<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>          retVal<span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="title">onFulfilledNext<span class="log">(</span></span>res<span class="log">)</span>,err<span class="log"> => </span><span class="title">onRejectedNext<span class="log">(</span></span>err<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>          <span class="title">onFulfilledNext<span class="log">(</span></span>value<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>      <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span>;</code><code data-key='xmp'>    <span class="title">switch<span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">_status</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">case </span>PENDING: <span class="let">this</span><span class="log">.</span><span class="title1">onFulfilledQueues</span><span class="log">.</span><span class="title1">push</span><span class="log">(</span>fulfilled<span class="log">)</span>;<span class="let">this</span><span class="log">.</span><span class="title1">onRejectedQueues</span><span class="log">.</span><span class="title1">push</span><span class="log">(</span>rejected<span class="log">)</span>;break;</code><code data-key='xmp'>      <span class="let">case </span>FULFILLED: <span class="title">fulfilled<span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;break;</code><code data-key='xmp'>      <span class="let">case </span>REJECTED: <span class="title">rejected<span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">_value</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">catch<span class="log">(</span></span>cb<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span> <span class="let">this</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span><span class='keyword'>undefined</span>,cb<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  static <span class="title">resolve<span class="log">(</span></span>value<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>value<span class="let"> instanceof </span>Promise<span class="log">)</span><span class="let">return</span> value;</code><code data-key='xmp'>    <span class="let">return</span> <span class="title">Promise<span class="log">(</span></span>resolve<span class="log"> => </span><span class="title">resolve<span class="log">(</span></span>value<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  static <span class="title">reject<span class="log">(</span></span>value<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>value<span class="let"> instanceof </span>Promise<span class="log">)</span><span class="let">return</span> value;</code><code data-key='xmp'>    <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span>value<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  static <span class="title">all<span class="log">(</span></span>list<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span> <span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'><span class="let">      let </span>count <span class="let">=</span> 0,result <span class="let">=</span> [];</code><code data-key='xmp'>      <span class="title"><span class="let">for</span><span class="log">(</span></span><span class="let">let </span>promise <span class="let">of</span> list<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>promise<span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>          count<span class="let">+</span><span class="let">+</span>;</code><code data-key='xmp'>          result<span class="log">.</span><span class="title1">push</span><span class="log">(</span>res<span class="log">)</span>;</code><code data-key='xmp'>          <span class="title"><span class="let">if</span><span class="log">(</span></span>count <span class="let">===</span> list<span class="log">.</span><span class="title1">length</span><span class="log">)</span><span class="log">{</span>resolve<span class="log">(</span>result<span class="log">)</span>;<span class="log">}</span></code><code data-key='xmp'>        <span class="log">}</span>,err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>          <span class="title">reject<span class="log">(</span></span>err<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  static <span class="title">race<span class="log">(</span></span>list<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>      <span class="title"><span class="let">for</span><span class="log">(</span></span><span class="let">let </span>promise <span class="let">of</span> list<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">this</span><span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>promise<span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>          <span class="title">resolve<span class="log">(</span></span>res<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span>,err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>          <span class="title">reject<span class="log">(</span></span>err<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  static <span class="title">finally<span class="log">(</span></span>onFinally<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span> <span class="let">this</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span>value<span class="log"> =></span><span class="let"> Promise</span><span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>onFinally<span class="log">(</span><span class="log">)</span><span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span><span class="log">(</span><span class="log">)</span><span class="log"> => </span>value<span class="log">)</span>,</code><code data-key='xmp'>         reason<span class="log"> =></span><span class="let"> Promise</span><span class="log">.</span><span class="title1">reject</span><span class="log">(</span>onFinally<span class="log">(</span><span class="log">)</span><span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span>throw reason<span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><div style='height: 14px;'></div>
                </div>
                <div class="rightDraw">
                <div class="menu"><div class="directory">目录</div><ul class="menuCon"><li class="menu_li"><a href="#前端异步的一些解决方案" id="Nb087520">前端异步的一些解决方案</a><ul class="menuCon_1"><li class="menu_li0"><a href="#Promise" id="HL615410">Promise</a><ul class="menuCon_2"><li class="menu_li0"><a href="#简介" id="Mh025111">简介</a></li><li class="menu_li1"><a href="#简单使用" id="ZC032730">简单使用</a></li></ul></li><li class="menu_li1"><a href="#Promise源码和注解" id="af624062">Promise源码和注解</a></li></ul></li></ul></div>
                </div>
              </div>
           </div>
           <svg t="1648304059372" class="icon up" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3132" width="200" height="200"><path d="M832 64 192 64C121.6 64 64 121.6 64 192l0 640c0 70.4 57.6 128 128 128l640 0c70.4 0 128-57.6 128-128L960 192C960 121.6 902.4 64 832 64zM762.24 759.04c-12.8 12.8-33.28 12.8-45.44 0L513.92 560l-202.24 199.04c-12.8 12.8-33.28 12.8-45.44 0-12.8-12.8-12.8-32.64 0-45.44l224-220.16c6.4-6.4 15.36-9.6 24.32-8.96C522.88 483.84 531.2 487.04 538.24 493.44l224 220.16C775.04 726.4 775.04 746.24 762.24 759.04zM762.24 503.04c-12.8 12.8-33.28 12.8-45.44 0L513.92 304 311.68 503.04c-12.8 12.8-33.28 12.8-45.44 0-12.8-12.8-12.8-32.64 0-45.44l224-220.16c6.4-6.4 15.36-9.6 24.32-8.96C522.88 227.84 531.2 231.04 538.24 237.44l224 220.16C775.04 470.4 775.04 490.24 762.24 503.04z" p-id="3133" fill="#ffffff"></path></svg>
        </div>
        </body>
           <script>let titles = [{"title":"前端异步的一些解决方案","id":"前端异步的一些解决方案","index":2,"class":"Nb087520","children":[{"title":"Promise","id":"Promise","index":3,"class":"HL615410","children":[{"title":"简介","id":"简介","index":4,"class":"Mh025111"},{"title":"简单使用","id":"简单使用","index":4,"class":"ZC032730"}]},{"title":"Promise源码和注解","id":"Promise源码和注解","index":3,"class":"af624062"}]}];</script>
           <script src="../index.js" type="text/javascript"></script>
           </html>
            