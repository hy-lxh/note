
        <!DOCTYPE html>
         <html lang="en">
         <head>
	     <meta charset="UTF-8">
         <meta name="keywords" content="小程序的一些东西,博客,前端"/>
         <meta name="description" content="微信小程序的相关知识"/>
         <!--<meta http-equiv="content-security-policy" content="default-src self"/>-->
	     <title>小程序的一些东西</title>
        </head>
        <link rel="stylesheet" href="../main.css">
        <body>
        <div class="message_box"></div>
        <div class="content">
           <div id="view">
              <div>
                <div class="bs_content">
                   <h3 id='小程序' class='MD166106'>小程序</h3><h4 id='获取openid' class='fF845416'>获取openid</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div></div><div class="codePre"><code data-key='xmp'><span class="green">获取openid需要使用到code以及appid、secret</span></code><code data-key='xmp'><span class="green">首先调用wx<span class="log">.</span><span class="title1">login</span>获取到code</span></code><code data-key='xmp'>wx<span class="log">.</span><span class="title1">login</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  <span class="title">success<span class="log">(</span></span>res<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">const </span><span class="log">{</span>code<span class="log">}</span> <span class="let">=</span> res<span class="log">.</span><span class="title1">data</span>,appid <span class="let">=</span> <span class="string">"you appid"</span>,secret <span class="let">=</span> <span class="string">"you secret"</span>;</code><code data-key='xmp'>    <span class="let">const </span>url <span class="let">=</span> `https:/\/api<span class="log">.</span><span class="title1">weixin</span><span class="log">.</span><span class="title1">qq</span><span class="log">.</span><span class="title1">com</span>/sns/jscode2session?appid=$<span class="log">{</span>appid<span class="log">}</span><span class="let">&</span>secret=$<span class="log">{</span>secret<span class="log">}</span><span class="let">&</span>js_code=$<span class="log">{</span>code<span class="log">}</span><span class="let">&</span>grant_type=authorization_code`;</code><code data-key='xmp'>    wx<span class="log">.</span><span class="title1">request</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>      url,</code><code data-key='xmp'>      dataType: <span class="string">"json"</span>,</code><code data-key='xmp'>      method: <span class="string">"get"</span>,</code><code data-key='xmp'>      header: <span class="log">{</span></code><code data-key='xmp'>        <span class="string">"content-type"</span>: <span class="string">"application/json"</span></code><code data-key='xmp'>      <span class="log">}</span>,</code><code data-key='xmp'>      <span class="title">success<span class="log">(</span></span>res<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">statusCode</span> <span class="let">===</span> 200 <span class="let">&</span><span class="let">&</span> res<span class="log">.</span><span class="title1">errMsg</span> <span class="let">===</span> <span class="string">"request:ok"</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>          console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>res<span class="log">)</span>;<span class="green"><span class="log">{</span>openid: </span><span class="string">"openid"</span>,ssession_key: <span class="string">"session_key"</span><span class="log">}</span></code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>      <span class="log">}</span>,</code><code data-key='xmp'>      <span class="title">fail<span class="log">(</span></span>err<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>err<span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span>,</code><code data-key='xmp'>      <span class="title">complete<span class="log">(</span></span><span class="log">)</span><span class="log">{</span><span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='获取unionid' class='bG229311'>获取unionid</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div></div><div class="codePre"><code data-key='xmp'><span class="green">调用unionid需要access_token和openid获取</span></code><code data-key='xmp'><span class="green">通过请求https://api<span class="log">.</span><span class="title1">weixin</span><span class="log">.</span><span class="title1">qq</span><span class="log">.</span><span class="title1">com</span>/cgi<span class="let">-</span>bin/user/info?access_token=ACCESS_TOKEN<span class="let">&</span>openid=OPENID<span class="let">&</span>lang=zh_CN接口获取</span></code><code data-key='xmp'><span class="green">access_token也是需要调用微信这边提供的接口https://api<span class="log">.</span><span class="title1">weixin</span><span class="log">.</span><span class="title1">qq</span><span class="log">.</span><span class="title1">com</span>/cgi<span class="let">-</span>bin/token?grant_type=client_credential<span class="let">&</span>appid=APPID<span class="let">&</span>secret=APPSECRET,根据openid和secret</span></code><code data-key='xmp'><span class="let">const </span>url <span class="let">=</span> `https://api<span class="log">.</span><span class="title1">weixin</span><span class="log">.</span><span class="title1">qq</span><span class="log">.</span><span class="title1">com</span>/cgi<span class="let">-</span>bin/token?grant_type=client_credential<span class="let">&</span>appid=APPID<span class="let">&</span>secret=APPSECRET`;</code><code data-key='xmp'>wx<span class="log">.</span><span class="title1">request</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  url,</code><code data-key='xmp'>  method: <span class="string">"get"</span>,</code><code data-key='xmp'>  dataType: <span class="string">"json"</span>,</code><code data-key='xmp'>  header: <span class="log">{</span></code><code data-key='xmp'>    <span class="string">"content-type"</span>: <span class="string">"application/json"</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">success<span class="log">(</span></span>res<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">statusCode</span> <span class="let">===</span> 200 <span class="let">&</span><span class="let">&</span> res<span class="log">.</span><span class="title1">errMsg</span> <span class="let">===</span> <span class="string">"request:ok"</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">const </span><span class="log">{</span>expires_in,access_token<span class="log">}</span> <span class="let">=</span> res<span class="log">.</span><span class="title1">data</span>;</code><code data-key='xmp'>      expires_in <span class="let">+</span><span class="let">=</span><span class="let"> new </span><span class="title">Date<span class="log">(</span></span><span class="log">)</span><span class="log">.</span><span class="title1">getTime</span><span class="log">(</span><span class="log">)</span>;</code><code data-key='xmp'>      wx<span class="log">.</span><span class="title1">setStorageSync</span><span class="log">(</span><span class="string">"accessToken"</span>,JSON<span class="log">.</span><span class="title1">stringify</span><span class="log">(</span><span class="log">{</span>expires_in,access_token<span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">fail<span class="log">(</span></span>err<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>err<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="green">把access_token存起来,过期了再获取,因为一天只能获取有限次</span></code><code data-key='xmp'><span class="green">unionid还可以通过wx<span class="log">.</span><span class="title1">getUserInfo</span> apid 获取到encryptedData,iv，通过wx<span class="log">.</span><span class="title1">login</span>获取到code,传送至服务器</span></code><code data-key='xmp'><span class="green">服务器再根据code获取到session_key,结合session_key,encryptedData,iv解密得到unionid以及openid</span></code></div></pre><h4 id='nodejs解密代码' class='ei863044'>nodejs解密代码</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div><div class='index'>29.</div><div class='index'>30.</div><div class='index'>31.</div><div class='index'>32.</div><div class='index'>33.</div><div class='index'>34.</div><div class='index'>35.</div><div class='index'>36.</div><div class='index'>37.</div><div class='index'>38.</div><div class='index'>39.</div><div class='index'>40.</div><div class='index'>41.</div><div class='index'>42.</div><div class='index'>43.</div><div class='index'>44.</div><div class='index'>45.</div><div class='index'>46.</div><div class='index'>47.</div><div class='index'>48.</div><div class='index'>49.</div><div class='index'>50.</div><div class='index'>51.</div><div class='index'>52.</div><div class='index'>53.</div><div class='index'>54.</div><div class='index'>55.</div><div class='index'>56.</div><div class='index'>57.</div><div class='index'>58.</div><div class='index'>59.</div><div class='index'>60.</div><div class='index'>61.</div><div class='index'>62.</div><div class='index'>63.</div><div class='index'>64.</div><div class='index'>65.</div><div class='index'>66.</div><div class='index'>67.</div><div class='index'>68.</div><div class='index'>69.</div><div class='index'>70.</div><div class='index'>71.</div><div class='index'>72.</div><div class='index'>73.</div><div class='index'>74.</div><div class='index'>75.</div><div class='index'>76.</div><div class='index'>77.</div><div class='index'>78.</div><div class='index'>79.</div><div class='index'>80.</div><div class='index'>81.</div><div class='index'>82.</div><div class='index'>83.</div><div class='index'>84.</div><div class='index'>85.</div></div><div class="codePre"><code data-key='xmp'><span class="let">const </span>appid <span class="let">=</span> <span class="string">"your appid"</span>,secret <span class="let">=</span> <span class="string">"your appSecret"</span>;</code><code data-key='xmp'><span class="let">let </span>encryptedData <span class="let">=</span> <span class="string">"接收过来的encrypedData"</span>,iv <span class="let">=</span> <span class="string">"接收过来的iv"</span>,code <span class="let">=</span> <span class="string">"接收过来的code"</span>;</code><code data-key='xmp'><span class="let">const </span>crypto <span class="let">=</span> <span class="title">require<span class="log">(</span></span><span class="string">"crypto"</span><span class="log">)</span>;<span class="green">nodejs内置解密加密模块</span></code><code data-key='xmp'><span class="let">const </span>https <span class="let">=</span> <span class="title">require<span class="log">(</span></span><span class="string">"https"</span><span class="log">)</span>;<span class="green">nodejs内置模块</span></code><code data-key='xmp'><span class="green">获取session_key</span></code><code data-key='xmp'><span class="let">async </span><span class='let'>function</span> <span class="title">getSessionKey<span class="log">(</span></span>appid,secret,code<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>  <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">const </span>url <span class="let">=</span> <span class="string">"https:/\/api.weixin.qq.com/sns/jscode2session?appid=${appid}&secret=${secret}&js_code=${code}&grant_type=authorization_code"</span>;</code><code data-key='xmp'>    try<span class="log">{</span></code><code data-key='xmp'>       <span class="let">const </span>res <span class="let">=</span> <span class="let">await </span><span class="title">request<span class="log">(</span></span>url<span class="log">)</span>;</code><code data-key='xmp'>       <span class="title">resolve<span class="log">(</span></span>res<span class="log">.</span><span class="title1">session_key</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span>catch<span class="log">(</span>e<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="title">reject<span class="log">(</span></span>e<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'> </code><code data-key='xmp'><span class="green">服务器请求的封装方法</span></code><code data-key='xmp'><span class='let'>function</span> <span class="title">request<span class="log">(</span></span>url,data<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>  <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    https<span class="log">.</span><span class="title1">get</span><span class="log">(</span>url,<span class="log">{</span>data<span class="log">}</span>,res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">let </span>res <span class="let">=</span> "";</code><code data-key='xmp'>      res<span class="log">.</span><span class="title1">on</span><span class="log">(</span><span class="string">"data"</span>,chunck<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        res <span class="let">+</span><span class="let">=</span> chunck;</code><code data-key='xmp'>      <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>      res<span class="log">.</span><span class="title1">on</span><span class="log">(</span><span class="string">"end"</span>,<span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="title">resolve<span class="log">(</span></span>JSON<span class="log">.</span><span class="title1">parse</span><span class="log">(</span>res<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>      res<span class="log">.</span><span class="title1">on</span><span class="log">(</span><span class="string">"error"</span>,err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="title">reject<span class="log">(</span></span>err<span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'> </code><code data-key='xmp'><span class="green">解密的类</span></code><code data-key='xmp'><span class="let">class </span>WxZipCryptedData <span class="log">{</span></code><code data-key='xmp'>  <span class="title"><span class="let">constructor</span><span class="log">(</span></span>appid,secretKey<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">appid</span> <span class="let">=</span> appid;</code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">sessionKey</span> <span class="let">=</span> sessionKey;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="title">decryptedData<span class="log">(</span></span>encryptedData,iv<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    encryptedData <span class="let">=</span><span class="let"> new </span><span class="title">Buffer<span class="log">(</span></span>encryptedData,<span class="string">"base64"</span><span class="log">)</span>;</code><code data-key='xmp'>    iv <span class="let">=</span><span class="let"> new </span><span class="title">Buffer<span class="log">(</span></span>iv,<span class="string">"base64"</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">let </span>sessionKey <span class="let">=</span><span class="let"> new </span><span class="title">Buffer<span class="log">(</span></span><span class="let">this</span><span class="log">.</span><span class="title1">sessionKey</span>,<span class="string">"base64"</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve,reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>      try<span class="log">{</span></code><code data-key='xmp'>         <span class="let">let </span>decipher <span class="let">=</span> crypto<span class="log">.</span><span class="title1">createDecipheriv</span><span class="log">(</span><span class="string">"aes-128-cbc"</span>,sessionKey,iv<span class="log">)</span>;</code><code data-key='xmp'>         <span class="let">let </span>decode <span class="let">=</span> decipher<span class="log">.</span><span class="title1">update</span><span class="log">(</span>encryptedData,<span class="string">"binary"</span>,<span class="string">"utf8"</span><span class="log">)</span>;</code><code data-key='xmp'>         decode <span class="let">+</span><span class="let">=</span> decipher<span class="log">.</span><span class="title1">final</span><span class="log">(</span><span class="string">"utf8"</span><span class="log">)</span>;</code><code data-key='xmp'>         decode <span class="let">=</span> JSON<span class="log">.</span><span class="title1">parse</span><span class="log">(</span>decode<span class="log">)</span>;</code><code data-key='xmp'>         <span class="title"><span class="let">if</span><span class="log">(</span></span>decode<span class="log">.</span><span class="title1">watermark</span><span class="log">.</span><span class="title1">appid</span> <span class="let">!</span><span class="let">==</span> <span class="let">this</span><span class="log">.</span><span class="title1">appid</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>           <span class="title">reject<span class="log">(</span></span><span class="string">"not equal appid"</span><span class="log">)</span>;</code><code data-key='xmp'>         <span class="log">}</span></code><code data-key='xmp'>         <span class="title">resolve<span class="log">(</span></span>decode<span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span>catch<span class="log">(</span>e<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>        <span class="title">reject<span class="log">(</span></span>e<span class="log">)</span>;</code><code data-key='xmp'>      <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'> </code><code data-key='xmp'>getSessionKey<span class="log">(</span>appid,secret,code<span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span><span class="let">async </span>sessionKey<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  <span class="let">let </span>pc <span class="let">=</span><span class="let"> new </span><span class="title">WxZipCryptedData<span class="log">(</span></span>appid,sessionKey<span class="log">)</span>;</code><code data-key='xmp'>  try<span class="log">{</span></code><code data-key='xmp'>    <span class="let">const </span>resp <span class="let">=</span> <span class="let">await </span>pc<span class="log">.</span><span class="title1">decryptedData</span><span class="log">(</span>encryptedData,iv<span class="log">)</span>;</code><code data-key='xmp'>    res<span class="log">.</span><span class="title1">send</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>      success: <span class="let">true</span>,</code><code data-key='xmp'>      data: resp,</code><code data-key='xmp'>      errMsg: <span class="string">"request:ok"</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span>catch<span class="log">(</span>e<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    res<span class="log">.</span><span class="title1">send</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>      success: <span class="let">false</span>,</code><code data-key='xmp'>      data: e,</code><code data-key='xmp'>      errMsg: <span class="string">"decryptedData err"</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">.</span><span class="title1">catch</span><span class="log">(</span>err<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  res<span class="log">.</span><span class="title1">send</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    success: <span class="let">false</span>,</code><code data-key='xmp'>    data: err,</code><code data-key='xmp'>    errMsg: <span class="string">"get session_key err"</span>;</code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h3 id='蓝牙设备连接' class='Zd356907'>蓝牙设备连接</h3><h4 id='openBluetoothAdapter' class='IE901870'>openBluetoothAdapter</h4><p class="indent">初始化蓝牙适配器,一般<span class="highlight">success回调函数返回的errMsg属性</span>包含<span class="highlight">ok</span>就表示设备蓝牙已经成功开启</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">openBluetoothAdapter</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res?<span class="log">.</span>errMsg<span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">进行下一步操作 <span class="let">-</span>> 检测蓝牙是否可用</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">提示用户蓝牙未开启</span></code><code data-key='xmp'>      <span class="green">这里面还可以设置一个监听蓝牙状态</span></code><code data-key='xmp'>      <span class="green">当用户开启蓝牙了直接下一步,就不用再去从头开始</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">失败,显示失败原因,继续监听蓝牙状态</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><h4 id='closeBluetoothAdapter' class='Ma753513'>closeBluetoothAdapter</h4><p class="indent">关闭蓝牙适配器,这个操作需要在一切操作结束之后执行或者出现错误终止操作后执行</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">closeBluetoothAdapter</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">成功关闭</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">出现问题了</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">关闭失败</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='onBluetoothAdapterStateChange' class='KL948909'>onBluetoothAdapterStateChange</h4><p class="indent">监听蓝牙设备开启或者关闭状态转换</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">onBluetoothAdapterStateChange</span><span class="log">(</span><span class="log">(</span>res<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  <span class="title"><span class="let">if</span><span class="log">(</span></span>res?<span class="log">.</span>available<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">蓝牙开启,关闭监听,下一步操作</span></code><code data-key='xmp'>  <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">用户关闭蓝牙</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><p class="indent">这块还需要针对<span class="highlight">openBluetoothAdapterStateChange</span>对性能是否有影响,不能长时间开启,可以在开启监听的时候设置一个定时器和一个全局变量,如果在一定时间内用户未开启蓝牙,直接取消监听,并且提示用户信息,并且不用再在用户打开后取消监听了,因为无论如何都会关闭监听的</p><p class="indent">如果一定要在用户打开蓝牙后关闭监听,就设置一个全局变量,当监听到用户打开蓝牙并且关闭监听后将全局变量设置为<span class="highlight">false</span>,在定时器里面加个条件判断,如果全局变量是<span class="highlight">true</span>才会执行</p><h4 id='offBluetoothAdapterStateChange' class='GC070460'>offBluetoothAdapterStateChange</h4><p class="indent">关闭蓝牙状态监听</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">offBluetoothAdapterStateChange</span><span class="log">(</span><span class="log">)</span>;</code></div></pre><h4 id='getBluetoothAdapterState' class='fe910269'>getBluetoothAdapterState</h4><p class="indent">判断蓝牙是否可用</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">getBluetoothAdapterState</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">available</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">蓝牙可用,继续执行下一步</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">蓝牙不可用,提示错误信息,巴拉巴拉</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">蓝牙不可用,提示错误信息,巴拉巴拉</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='startBluetoothDevicesDiscovery' class='hh504022'>startBluetoothDevicesDiscovery</h4><p class="indent">搜索蓝牙设备</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">startBluetoothDevicesDiscovery</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  services: [],<span class="green">设置自己设备的serviceId,过滤掉不符合条件的,可选的参数,也可以不传</span></code><code data-key='xmp'>  allowDuplicatesKey: <span class="let">false</span>,<span class="green">是否允许同一设备上报</span></code><code data-key='xmp'>  interval: 100,<span class="green">多少毫秒上报一次</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">进行下一步</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">报错,提示错误信息</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='getBluetoothDevices' class='FD848521'>getBluetoothDevices</h4><p class="indent">获取当前设备之前连接过的所有设备</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">getBluetoothDevices</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>       <span class="let">const </span><span class="log">{</span>devices<span class="log">}</span> <span class="let">=</span> res;</code><code data-key='xmp'>      <span class="green">数据基本上就是一个数组</span></code><code data-key='xmp'>      <span class="green">[<span class="log">{</span>name: </span><span class="string">"设备名字"</span>,localName: <span class="string">"和name一样"</span>,deviceId: <span class="string">"设备id,主要是用这个"</span>,advertisData: <span class="string">"广播数据,16进制的"</span><span class="log">}</span>];</code><code data-key='xmp'>      <span class="green">筛选出和你所要找到的设备名相同的再进行下一步将设备的deviceId传递下去</span></code><code data-key='xmp'>      <span class="green">如果没有符合条件的设备,开启搜索设备,设置个定时器,过多久还没找到设备就关闭搜索,并且提示信息</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">没有获取到</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">api使用出现错误</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><h4 id='onBluetoothDeviceFound' class='Xc656730'>onBluetoothDeviceFound</h4><p class="indent">这个api是用于发现新设备,如果发现新设备就执行传递过来的回调方法,在startBluetoothDevicesDiscovery中执行</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">onBluetoothDeviceFound</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  <span class="green">这里面其实和getBluetoothDevices里面的操作相同</span></code><code data-key='xmp'>  <span class="green">这不过如果找到设备了就取消定时器执行</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><h4 id='stopBluetoothDevicesDiscovery' class='hM963108'>stopBluetoothDevicesDiscovery</h4><p class="indent">停止搜索</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">stopBluetoothDevicesDiscovery</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">成功关闭</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">关闭失败</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='createBLEConnection' class='hX628512'>createBLEConnection</h4><p class="indent">这个api是和匹配上的设备进行连接</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">createBLEConnection</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  deviceId: <span class="string">"设备的deviceId"</span>,<span class="green">从上一步传递过来</span></code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">连接成功后，继续下一步获取设备的ServiceId</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">连接失败</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">连接失败了,这里面可以设置一个全局的重连变量,失败了继续连接，直到到达一定的时间后就不连接了,提示信息</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='getBLEDeviceServices' class='iD089550'>getBLEDeviceServices</h4><p class="indent">获取设备的serviceId,这个要用于获取设备的characteristicsId和写入操作</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">getBLEDeviceServices</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  deviceId: <span class="string">"设备的deviceId"</span>,</code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span> </code><code data-key='xmp'>      <span class="green">遍历res<span class="log">.</span><span class="title1">servces</span>,拿到符合条件的uuid,如果没有就关闭连接和适配器</span></code><code data-key='xmp'>      <span class="green">拿到了就直接下一步获取characteristicsId</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">获取失败,提示和关闭连接和适配器</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='getBELDeviceCharacteristics' class='CE006205'>getBELDeviceCharacteristics</h4><p class="indent">获取设备的characteristicsId</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">getBLEDeviceCharacteristics</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  deviceId: <span class="string">"设备的deviceId"</span>,</code><code data-key='xmp'>  serviceId: <span class="string">"设备的serviceId"</span>,</code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">const </span><span class="log">{</span>characteristics<span class="log">}</span> <span class="let">=</span> res;</code><code data-key='xmp'>      <span class="green">遍历characteristics,筛选出符合条件的写入uuid和读取uuid,进行设备写入指令入设备和监听硬件响应信息</span></code><code data-key='xmp'>      <span class="green">进行写入操作,将deviceId,seviceId,characteristicId传递下去,没找到就直接关闭连接和适配器</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">获取失败</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='writeBLECharateristicValue' class='Fe118737'>writeBLECharateristicValue</h4><p class="indent">设备向硬件写入指令api</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">writeBLECharacteristicValue</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  deviceId,</code><code data-key='xmp'>  serviceId,</code><code data-key='xmp'>  characteristicId,</code><code data-key='xmp'>  value: <span class="string">"buffer类型的"</span>,</code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">写入成功</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">写入出现问题</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">写入失败</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><p class="indent">微信提供的这个api一次只能写入20个字节,超过20个字节需要分批写入或者使用setBLEMTU协商最大传输字节(这个只有android能使用,ios不兼容)</p><h4 id='notifyBLECharacteristicValueChange' class='NK380030'>notifyBLECharacteristicValueChange</h4><p class="indent">启用特征值变化,要监听返回值必须先启用这个再调用监听函数,这个api中的characteristicId中的properties.notify或者properties.indicate其中一个需要是true</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div></div><div class="codePre"><code data-key='xmp'>wx<span class="log">.</span><span class="title1">ontifyBLECharacteristicValueChange</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  deviceId,</code><code data-key='xmp'>  serviceId,</code><code data-key='xmp'>  characteristicId,</code><code data-key='xmp'>  state: <span class="let">true</span>,</code><code data-key='xmp'>  success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="title"><span class="let">if</span><span class="log">(</span></span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">进行返回值监听</span></code><code data-key='xmp'>    <span class="log">}</span><span class="let">else</span><span class="log">{</span></code><code data-key='xmp'>      <span class="green">启用出现错误</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">启用失败</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='onBLECharacteristicValueChange' class='Ff411503'>onBLECharacteristicValueChange</h4><p class="indent">监听硬件响应,在notifyBLECharacteristicValueChange调用成功后执行</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div></div><div class="codePre"><code data-key='xmp'><span class="green">返回值都是16进制的</span></code><code data-key='xmp'>wx<span class="log">.</span><span class="title1">onBLECharacteristicValueChange</span><span class="log">(</span>res<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  <span class="green">res<span class="log">.</span><span class="title1">value</span>就是响应内容,转换就好了</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h4 id='进制转换' class='aI392419'>进制转换</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div></div><div class="codePre"><code data-key='xmp'><span class="green">16进制转换为10进制</span></code><code data-key='xmp'>parseInt<span class="log">(</span>value,16<span class="log">)</span>;<span class="green">parseInt是目标进制向10进制转换</span></code><code data-key='xmp'><span class="green">10进制转换为16进制</span></code><code data-key='xmp'>Number<span class="log">(</span>value<span class="log">)</span><span class="log">.</span><span class="title1">toString</span><span class="log">(</span>16<span class="log">)</span>;<span class="green">toString是10进制向目标进制转换</span></code></div></pre><h4 id='字符串转换为buffer' class='iC851620'>字符串转换为buffer</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div></div><div class="codePre"><code data-key='xmp'><span class='let'>function</span> <span class="title">str2buffer<span class="log">(</span></span>str<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>  <span class="let">const </span>buffer <span class="let">=</span><span class="let"> new </span><span class="title">Uint8Array<span class="log">(</span></span>str<span class="log">.</span><span class="title1">match</span><span class="log">(</span>/[\da<span class="let">-</span>f]<span class="log">{</span>2<span class="log">}</span>/gi<span class="log">)</span><span class="log">.</span><span class="title1">map</span><span class="log">(</span><span class='let'>function</span> <span class="log">(</span>h<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span> <span class="title">parseInt<span class="log">(</span></span>h, 16<span class="log">)</span></code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="let">return</span> Array<span class="log">.</span><span class="title1">prototype</span><span class="log">.</span><span class="title1">slice</span><span class="log">.</span><span class="title1">call</span><span class="log">(</span><span class="let">new </span><span class="title">Uint8Array<span class="log">(</span></span>buffer<span class="log">.</span><span class="title1">buffer</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code></div></pre><h4 id='buffer转换成字符串' class='gb113559'>buffer转换成字符串</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div></div><div class="codePre"><code data-key='xmp'><span class='let'>function</span> <span class="title">buf2string<span class="log">(</span></span>buffer<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>  <span class="let">let </span>arr <span class="let">=</span> Array<span class="log">.</span><span class="title1">prototype</span><span class="log">.</span><span class="title1">map</span><span class="log">.</span><span class="title1">call</span><span class="log">(</span><span class="let">new </span><span class="title">Uint8Array<span class="log">(</span></span>buffer<span class="log">)</span>, x<span class="log"> => </span>x<span class="log">)</span></code><code data-key='xmp'>  <span class="let">return</span> arr<span class="log">.</span><span class="title1">map</span><span class="log">(</span><span class="log">(</span>char, i<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">return</span> char<span class="log">.</span><span class="title1">toString</span><span class="log">(</span>16<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span><span class="log">.</span><span class="title1">join</span><span class="log">(</span>''<span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h4 id='案例' class='cM899952'>案例</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div style='height: 14px;'></div><div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div><div class='index'>29.</div><div class='index'>30.</div><div class='index'>31.</div><div class='index'>32.</div><div class='index'>33.</div><div class='index'>34.</div><div class='index'>35.</div><div class='index'>36.</div><div class='index'>37.</div><div class='index'>38.</div><div class='index'>39.</div><div class='index'>40.</div><div class='index'>41.</div><div class='index'>42.</div><div class='index'>43.</div><div class='index'>44.</div><div class='index'>45.</div><div class='index'>46.</div><div class='index'>47.</div><div class='index'>48.</div><div class='index'>49.</div><div class='index'>50.</div><div class='index'>51.</div><div class='index'>52.</div><div class='index'>53.</div><div class='index'>54.</div><div class='index'>55.</div><div class='index'>56.</div><div class='index'>57.</div><div class='index'>58.</div><div class='index'>59.</div><div class='index'>60.</div><div class='index'>61.</div><div class='index'>62.</div><div class='index'>63.</div><div class='index'>64.</div><div class='index'>65.</div><div class='index'>66.</div><div class='index'>67.</div><div class='index'>68.</div><div class='index'>69.</div><div class='index'>70.</div><div class='index'>71.</div><div class='index'>72.</div><div class='index'>73.</div><div class='index'>74.</div><div class='index'>75.</div><div class='index'>76.</div><div class='index'>77.</div><div class='index'>78.</div><div class='index'>79.</div><div class='index'>80.</div><div class='index'>81.</div><div class='index'>82.</div><div class='index'>83.</div><div class='index'>84.</div><div class='index'>85.</div><div class='index'>86.</div><div class='index'>87.</div><div class='index'>88.</div><div class='index'>89.</div><div class='index'>90.</div><div class='index'>91.</div><div class='index'>92.</div><div class='index'>93.</div><div class='index'>94.</div><div class='index'>95.</div><div class='index'>96.</div><div class='index'>97.</div><div class='index'>98.</div><div class='index'>99.</div><div class='index'>100.</div><div class='index'>101.</div><div class='index'>102.</div><div class='index'>103.</div><div class='index'>104.</div><div class='index'>105.</div><div class='index'>106.</div><div class='index'>107.</div><div class='index'>108.</div><div class='index'>109.</div><div class='index'>110.</div><div class='index'>111.</div><div class='index'>112.</div><div class='index'>113.</div><div class='index'>114.</div><div class='index'>115.</div><div class='index'>116.</div><div class='index'>117.</div><div class='index'>118.</div><div class='index'>119.</div><div class='index'>120.</div><div class='index'>121.</div><div class='index'>122.</div><div class='index'>123.</div><div class='index'>124.</div><div class='index'>125.</div><div class='index'>126.</div><div class='index'>127.</div><div class='index'>128.</div><div class='index'>129.</div><div class='index'>130.</div><div class='index'>131.</div><div class='index'>132.</div><div class='index'>133.</div><div class='index'>134.</div><div class='index'>135.</div><div class='index'>136.</div><div class='index'>137.</div><div class='index'>138.</div><div class='index'>139.</div><div class='index'>140.</div><div class='index'>141.</div><div class='index'>142.</div><div class='index'>143.</div><div class='index'>144.</div><div class='index'>145.</div><div class='index'>146.</div><div class='index'>147.</div><div class='index'>148.</div><div class='index'>149.</div><div class='index'>150.</div><div class='index'>151.</div><div class='index'>152.</div><div class='index'>153.</div><div class='index'>154.</div><div class='index'>155.</div><div class='index'>156.</div><div class='index'>157.</div><div class='index'>158.</div><div class='index'>159.</div><div class='index'>160.</div><div class='index'>161.</div><div class='index'>162.</div><div class='index'>163.</div><div class='index'>164.</div><div class='index'>165.</div><div class='index'>166.</div><div class='index'>167.</div><div class='index'>168.</div><div class='index'>169.</div><div class='index'>170.</div><div class='index'>171.</div><div class='index'>172.</div><div class='index'>173.</div><div class='index'>174.</div><div class='index'>175.</div><div class='index'>176.</div><div class='index'>177.</div><div class='index'>178.</div><div class='index'>179.</div><div class='index'>180.</div><div class='index'>181.</div><div class='index'>182.</div><div class='index'>183.</div><div class='index'>184.</div><div class='index'>185.</div><div class='index'>186.</div><div class='index'>187.</div><div class='index'>188.</div><div class='index'>189.</div><div class='index'>190.</div><div class='index'>191.</div><div class='index'>192.</div><div class='index'>193.</div><div class='index'>194.</div><div class='index'>195.</div><div class='index'>196.</div><div class='index'>197.</div><div class='index'>198.</div><div class='index'>199.</div><div class='index'>200.</div><div class='index'>201.</div><div class='index'>202.</div><div class='index'>203.</div><div class='index'>204.</div><div class='index'>205.</div><div class='index'>206.</div><div class='index'>207.</div><div class='index'>208.</div><div class='index'>209.</div><div class='index'>210.</div><div class='index'>211.</div><div class='index'>212.</div><div class='index'>213.</div><div class='index'>214.</div><div class='index'>215.</div><div class='index'>216.</div><div class='index'>217.</div><div class='index'>218.</div><div class='index'>219.</div><div class='index'>220.</div><div class='index'>221.</div><div class='index'>222.</div><div class='index'>223.</div><div class='index'>224.</div><div class='index'>225.</div><div class='index'>226.</div><div class='index'>227.</div><div class='index'>228.</div><div class='index'>229.</div><div class='index'>230.</div><div class='index'>231.</div><div class='index'>232.</div><div class='index'>233.</div><div class='index'>234.</div><div class='index'>235.</div><div class='index'>236.</div><div class='index'>237.</div><div class='index'>238.</div><div class='index'>239.</div><div class='index'>240.</div><div class='index'>241.</div><div class='index'>242.</div><div class='index'>243.</div><div class='index'>244.</div><div class='index'>245.</div><div class='index'>246.</div><div class='index'>247.</div><div class='index'>248.</div><div class='index'>249.</div><div class='index'>250.</div><div class='index'>251.</div><div class='index'>252.</div><div class='index'>253.</div><div class='index'>254.</div><div class='index'>255.</div><div class='index'>256.</div><div class='index'>257.</div><div class='index'>258.</div><div class='index'>259.</div><div class='index'>260.</div><div class='index'>261.</div><div class='index'>262.</div><div class='index'>263.</div><div class='index'>264.</div><div class='index'>265.</div><div class='index'>266.</div><div class='index'>267.</div><div class='index'>268.</div><div class='index'>269.</div><div class='index'>270.</div><div class='index'>271.</div><div class='index'>272.</div><div class='index'>273.</div><div class='index'>274.</div><div class='index'>275.</div><div class='index'>276.</div><div class='index'>277.</div><div class='index'>278.</div><div class='index'>279.</div><div class='index'>280.</div><div class='index'>281.</div><div class='index'>282.</div><div class='index'>283.</div><div class='index'>284.</div><div class='index'>285.</div><div class='index'>286.</div><div class='index'>287.</div><div class='index'>288.</div><div class='index'>289.</div><div class='index'>290.</div><div class='index'>291.</div><div class='index'>292.</div><div class='index'>293.</div><div class='index'>294.</div><div class='index'>295.</div><div class='index'>296.</div><div class='index'>297.</div><div class='index'>298.</div><div class='index'>299.</div><div class='index'>300.</div><div class='index'>301.</div><div class='index'>302.</div><div class='index'>303.</div><div class='index'>304.</div><div class='index'>305.</div><div class='index'>306.</div><div class='index'>307.</div><div class='index'>308.</div><div class='index'>309.</div><div class='index'>310.</div><div class='index'>311.</div><div class='index'>312.</div><div class='index'>313.</div><div class='index'>314.</div><div class='index'>315.</div><div class='index'>316.</div><div class='index'>317.</div><div class='index'>318.</div><div class='index'>319.</div><div class='index'>320.</div><div class='index'>321.</div><div class='index'>322.</div><div class='index'>323.</div><div class='index'>324.</div><div class='index'>325.</div><div class='index'>326.</div><div class='index'>327.</div><div class='index'>328.</div><div class='index'>329.</div><div class='index'>330.</div><div class='index'>331.</div><div class='index'>332.</div><div class='index'>333.</div><div class='index'>334.</div><div class='index'>335.</div><div class='index'>336.</div></div><div class="codePre"><code data-key='xmp'><span class="let">import </span><span class="log">{</span> updatePeopleCache <span class="log">}</span><span class="let"> from </span><span class="string">"../api/index"</span>;</code><code data-key='xmp'><span class="let">import </span><span class="log">{</span> bleOpenDoorPost, returnOrder <span class="log">}</span><span class="let"> from </span><span class="string">"../api/bleRcord"</span>;</code><code data-key='xmp'><span class="let">import </span><span class="log">{</span> getDeviceMess <span class="log">}</span><span class="let"> from </span><span class="string">"../api/setting"</span>;</code><code data-key='xmp'><span class="let">import </span><span class="log">{</span> dealOrderKey, hideLoading, showLoading, showModal, showToast <span class="log">}</span><span class="let"> from </span><span class="string">"./util"</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>bleDefaultTip <span class="let">=</span> <span class="log">{</span></code><code data-key='xmp'>    searchTip: <span class="string">"搜索中..."</span>,</code><code data-key='xmp'>    connectTip: <span class="string">"连接中..."</span>,</code><code data-key='xmp'>    issueDirTip: <span class="string">"数据下发中..."</span>,</code><code data-key='xmp'>    issueDirSuccTip: <span class="string">"下发成功"</span>,</code><code data-key='xmp'>    issueDirErrTip: <span class="string">"下发失败"</span>,</code><code data-key='xmp'>    deviceNotReplyTip: <span class="string">"未接收到门锁回复"</span>,</code><code data-key='xmp'>    disconnectTip: <span class="string">"连接中断,请重新连接发送"</span>,</code><code data-key='xmp'>    waitDeviceReplyTime: 7000,</code><code data-key='xmp'>    bleSearchTime: 5000</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">const </span>errorMap: <span class="log">{</span> [k: string]: string <span class="log">}</span> <span class="let">=</span> <span class="log">{</span></code><code data-key='xmp'>    <span class="string">"10000"</span>: <span class="string">"未初始化蓝牙适配器"</span>,</code><code data-key='xmp'>    <span class="string">"10001"</span>: <span class="string">"当前蓝牙适配器不可用"</span>,</code><code data-key='xmp'>    <span class="string">"10002"</span>: <span class="string">"没有找到指定设备"</span>,</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">const </span>getSetting <span class="let">=</span> <span class="log">(</span>reject<span class="colonColor">: </span><span class="typeColor">Function</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>WechatMiniprogram.AuthSetting</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span>resolve<span class="log"> => </span>wx<span class="log">.</span><span class="title1">getSetting</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    success: <span class="log">(</span>res<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">GetSettingSuccessCallbackResult</span><span class="log">)</span></span><span class="log"> => </span><span class="title">resolve<span class="log">(</span></span>res<span class="log">.</span><span class="title1">authSetting</span><span class="log">)</span>,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor">err</span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"获取系统权限出错"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>getLocationAuth <span class="let">=</span> <span class="log">(</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>WechatMiniprogram.GeneralCallbackResult</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span>resolve<span class="log"> => </span>wx<span class="log">.</span><span class="title1">authorize</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    scope: <span class="string">"scope.userLocation"</span>,</code><code data-key='xmp'>    success: resolve,</code><code data-key='xmp'>    complete: resolve</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>openBluetoothAdapter <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="let">async </span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">let </span>settings <span class="let">=</span> <span class="let">await </span><span class="title">getSetting<span class="log">(</span></span>reject<span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span><span class="let">!</span>settings[<span class="string">"scope.userLocation"</span>]<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>settings[<span class="string">"scope.userLocation"</span>] <span class="let">===</span> <span class='keyword'>undefined</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="let">let </span>auth <span class="let">=</span> <span class="let">await </span><span class="title">getLocationAuth<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>            <span class="let">if </span><span class="log">(</span><span class="let">!</span>auth<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">"ok"</span><span class="log">)</span><span class="log">)</span> <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"请点右上角三点设置允许系统获取位置信息,搜索蓝牙时需要"</span> <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="let"> else </span><span class="log">{</span></code><code data-key='xmp'>            <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"请点右上角三点设置允许系统获取位置信息,搜索蓝牙时需要"</span>, api: <span class="string">"getSetting"</span> <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    wx<span class="log">.</span><span class="title1">openBluetoothAdapter</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>        refreshCache: <span class="let">false</span>,</code><code data-key='xmp'>        success: resolve,</code><code data-key='xmp'>        fail<span class="colonColor">: </span><span class="typeColor">err</span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"蓝牙未开启或者蓝牙不可用"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>closeBluetoothAdapter <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="let">await </span>wx<span class="log">.</span><span class="title1">closeBluetoothAdapter</span><span class="log">(</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>getBluetoothAdapterState <span class="let">=</span> <span class="log">(</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>void</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="let">async </span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">getBluetoothAdapterState</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    success: <span class="log">(</span>res<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">GetBluetoothAdapterStateSuccessCallbackResult</span><span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>res<span class="log">.</span><span class="title1">available</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="title">resolve<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>        <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"蓝牙未开启或者蓝牙不可用"</span>, err<span class="colonColor">: </span><span class="typeColor">res <span class="log">}</span></span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span>,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor">err</span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"蓝牙未开启或者蓝牙不可用"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">let </span>adapterListener: <span class="log">(</span>res<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">OnBluetoothAdapterStateChangeCallbackResult</span><span class="log">)</span></span><span class="log"> => </span>void</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>onBluetoothAdapterStateChange <span class="let">=</span> <span class="let">async </span><span class="log">(</span>cb<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">await </span><span class="title">offBluetoothAdapterStateChange<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    adapterListener <span class="let">=</span> <span class="log">(</span>res<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">OnBluetoothAdapterStateChangeCallbackResult</span><span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="title">cb<span class="log">(</span></span>res<span class="log">.</span><span class="title1">available</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span>;</code><code data-key='xmp'>    wx<span class="log">.</span><span class="title1">onBluetoothAdapterStateChange</span><span class="log">(</span>adapterListener<span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>offBluetoothAdapterStateChange <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> =></span><span class="let"> new </span>Promise<span class='angleBracket'>&lt;</span><span class='elName'>void</span><span class='angleBracket'>&gt;</span><span class="log">(</span><span class="let">async </span>resolve<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    try <span class="log">{</span></code><code data-key='xmp'>        <span class="let">await </span>wx<span class="log">.</span><span class="title1">offBluetoothAdapterStateChange</span><span class="log">(</span>adapterListener<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span> catch <span class="log">(</span>err<span class="colonColor">: </span><span class="typeColor">any</span><span class="log">)</span> <span class="log">{</span> <span class="log">}</span>;</code><code data-key='xmp'>    <span class="title">resolve<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>startBluetoothDevicesDiscovery <span class="let">=</span> <span class="let">async </span><span class="log">(</span>devices<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">BlueToothDevice</span>[]</span> <span class="let">=</span> [], name: string, timeout<span class="colonColor">: </span><span class="typeColor">number</span> <span class="let">=</span> 5000, multiple<span class="colonColor">: </span><span class="typeColor">boolean</span> <span class="let">=</span> <span class="let">false</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>WechatMiniprogram.BlueToothDevice</span><span class='angleBracket'>&gt;</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">let </span>timer<span class="colonColor">: </span><span class="typeColor">number</span> <span class="let">=</span> 0, deviceMap <span class="let">=</span><span class="let"> new </span>Map<span class='angleBracket'>&lt;</span><span class='elName'>string,</span> boolean<span class='angleBracket'>&gt;</span><span class="log">(</span><span class="log">)</span></code><code data-key='xmp'>    <span class="let">const </span>dealDevice <span class="let">=</span> <span class="log">(</span>deviceList: Device[], resolve<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        deviceList<span class="log">.</span><span class="title1">filter</span><span class="log">(</span>device<span class="log"> => </span><span class="log">(</span>device<span class="log">.</span><span class="title1">name</span> <span class="let">&</span><span class="let">&</span> device<span class="log">.</span><span class="title1">name</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span>name<span class="log">)</span><span class="let"> || </span>device<span class="log">.</span><span class="title1">localName</span> <span class="let">&</span><span class="let">&</span> device<span class="log">.</span><span class="title1">localName</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span>name<span class="log">)</span><span class="log">)</span><span class="log">)</span><span class="log">.</span><span class="title1">forEach</span><span class="log">(</span>device<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>            <span class="let">const </span><span class="log">{</span> deviceId <span class="log">}</span> <span class="let">=</span> device;</code><code data-key='xmp'>            <span class="let">if </span><span class="log">(</span><span class="let">!</span>deviceMap<span class="log">.</span><span class="title1">has</span><span class="log">(</span>deviceId<span class="log">)</span> <span class="let">&</span><span class="let">&</span> <span class="log">(</span>multiple<span class="let"> || </span>devices<span class="log">.</span><span class="title1">length</span> <span class="let">===</span> 0<span class="log">)</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                deviceMap<span class="log">.</span><span class="title1">set</span><span class="log">(</span>deviceId, <span class="let">true</span><span class="log">)</span>;</code><code data-key='xmp'>                <span class="title">clearInterval<span class="log">(</span></span>timer<span class="log">)</span>;</code><code data-key='xmp'>                devices<span class="log">.</span><span class="title1">push</span><span class="log">(</span>device<span class="log">)</span>;</code><code data-key='xmp'>                <span class="let">if </span><span class="log">(</span><span class="let">!</span>multiple<span class="log">)</span> <span class="title">stopBluetoothDevicesDiscovery<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>                <span class="title">setTimeout<span class="log">(</span></span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="title">resolve<span class="log">(</span></span>device<span class="log">)</span>, 300<span class="log">)</span>;</code><code data-key='xmp'>            <span class="log">}</span></code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="let">return</span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        wx<span class="log">.</span><span class="title1">startBluetoothDevicesDiscovery</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>            allowDuplicatesKey: <span class="let">false</span>, <span class="green">允许上报同一设备</span></code><code data-key='xmp'>            interval: 0, <span class="green">上报间隔时间,越快越好</span></code><code data-key='xmp'>            powerLevel: <span class="string">"high"</span>, <span class="green">扫描模式，越高扫描越快,</span></code><code data-key='xmp'>            success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span><span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>                timer <span class="let">=</span> <span class="title">setTimeout<span class="log">(</span></span><span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>                    <span class="let">if </span><span class="log">(</span>devices<span class="log">.</span><span class="title1">length</span> <span class="let">===</span> 0<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                        <span class="let">await </span><span class="title">stopBluetoothDevicesDiscovery<span class="log">(</span></span><span class="log">)</span></code><code data-key='xmp'>                        <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"附近暂未搜索到您当前要连接到门锁，请确定门锁在您身边或重新尝试"</span>, modal<span class="colonColor">: </span><span class="typeColor">true <span class="log">}</span><span class="log">)</span></span>;</code><code data-key='xmp'>                    <span class="log">}</span></code><code data-key='xmp'>                <span class="log">}</span>, timeout<span class="log">)</span>;</code><code data-key='xmp'>                wx<span class="log">.</span><span class="title1">getBluetoothDevices</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>                    success<span class="colonColor">: </span><span class="typeColor">res</span><span class="log"> => </span><span class="title">dealDevice<span class="log">(</span></span>res?<span class="log">.</span>devices<span class="let"> || </span>[], resolve<span class="log">)</span>,</code><code data-key='xmp'>                    fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg<span class="colonColor">: </span><span class="typeColor">errorMap[String<span class="log">(</span>err<span class="log">.</span><span class="title1">errCode</span></span><span class="log">)</span>]<span class="let"> || </span>err<span class="log">.</span><span class="title1">errMsg</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>                <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>                wx<span class="log">.</span><span class="title1">onBluetoothDeviceFound</span><span class="log">(</span>res<span class="log"> => </span><span class="title">dealDevice<span class="log">(</span></span>res?<span class="log">.</span>devices<span class="let"> || </span>[], resolve<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>            <span class="log">}</span>,</code><code data-key='xmp'>            fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg<span class="colonColor">: </span><span class="typeColor">errorMap[String<span class="log">(</span>err<span class="log">.</span><span class="title1">errCode</span></span><span class="log">)</span>]<span class="let"> || </span>err<span class="log">.</span><span class="title1">errMsg</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>stopBluetoothDevicesDiscovery <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">stopBluetoothDevicesDiscovery</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    success: resolve,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"关闭搜索失败"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>createBLEConnection <span class="let">=</span> <span class="let">async </span><span class="log">(</span>deviceId<span class="colonColor">: </span><span class="typeColor">string</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>string</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">createBLEConnection</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    deviceId,</code><code data-key='xmp'>    timeout: 8000,</code><code data-key='xmp'>    connectionPriority: <span class="string">"high"</span>,</code><code data-key='xmp'>    success<span class="colonColor">: </span><span class="typeColor">res</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>res<span class="log">.</span><span class="title1">errCode</span><span class="let"> <= </span>0<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="title">resolve<span class="log">(</span></span>deviceId<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="let"> else </span><span class="log">{</span></code><code data-key='xmp'>            <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"连接失败,请重试"</span>, err: res, api: <span class="string">"createBLEConnection"</span> <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span>,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor">err</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>err<span class="log">.</span><span class="title1">errCode</span><span class="let"> <= </span><span class="let">-</span>1<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="title">resolve<span class="log">(</span></span>deviceId<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="let"> else </span><span class="log">{</span></code><code data-key='xmp'>            <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"连接失败,请重试"</span>, err, api: <span class="string">"createBLEConnection"</span> <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>closeBLEConnect <span class="let">=</span> <span class="let">async </span><span class="log">(</span>deviceId<span class="colonColor">: </span><span class="typeColor">string<span class="log">)</span></span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">closeBLEConnection</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    deviceId,</code><code data-key='xmp'>    success: resolve,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"关闭连接失败"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">let </span>connectListener: <span class="log">(</span>res<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">OnBLEConnectionStateChangeCallbackResult</span><span class="log">)</span></span><span class="log"> => </span>void</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>offBLEConnectionStateChange <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> =></span><span class="let"> new </span>Promise<span class='angleBracket'>&lt;</span><span class='elName'>void</span><span class='angleBracket'>&gt;</span><span class="log">(</span><span class="let">async </span>resolve<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    try <span class="log">{</span></code><code data-key='xmp'>        <span class="let">await </span>wx<span class="log">.</span><span class="title1">offBLEConnectionStateChange</span><span class="log">(</span>connectListener<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span> catch <span class="log">{</span> <span class="log">}</span></code><code data-key='xmp'>    <span class="title">resolve<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>watchBLEConnectState <span class="let">=</span> <span class="let">async </span><span class="log">(</span>cb<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">await </span><span class="title">offBLEConnectionStateChange<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    connectListener <span class="let">=</span> <span class="log">(</span>res<span class="colonColor">: </span><span class="typeColor">WechatMiniprogram<span class="log">.</span><span class="title1">OnBLEConnectionStateChangeCallbackResult</span><span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span><span class="let">!</span>res<span class="log">.</span><span class="title1">connected</span><span class="log">)</span> <span class="title">cb<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    wx<span class="log">.</span><span class="title1">onBLEConnectionStateChange</span><span class="log">(</span>connectListener<span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>getBLEDeviceServices <span class="let">=</span> <span class="let">async </span><span class="log">(</span>deviceId: string, prefix<span class="colonColor">: </span><span class="typeColor">string</span> <span class="let">=</span> <span class="string">"FFF0"</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>string</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">getBLEDeviceServices</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    deviceId,</code><code data-key='xmp'>    success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">let </span>service: <span class='keyword'>undefined</span><span class="let"> | </span>WechatMiniprogram<span class="log">.</span><span class="title1">BLEService</span> <span class="let">=</span> res<span class="log">.</span><span class="title1">services</span><span class="log">.</span><span class="title1">find</span><span class="log">(</span>service<span class="log"> => </span>service<span class="log">.</span><span class="title1">uuid</span> <span class="let">&</span><span class="let">&</span> service<span class="log">.</span><span class="title1">uuid</span><span class="log">.</span><span class="title1">substring</span><span class="log">(</span>4, 8<span class="log">)</span> <span class="let">===</span> prefix<span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>service<span class="log">)</span> <span class="title">resolve<span class="log">(</span></span>service<span class="log">.</span><span class="title1">uuid</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"未找到对应的serviceId"</span>, err<span class="colonColor">: </span><span class="typeColor">res <span class="log">}</span><span class="log">)</span></span>;</code><code data-key='xmp'>    <span class="log">}</span>,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"获取serviceId失败"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>getBLEDeviceCharacteristics <span class="let">=</span> <span class="log">(</span>deviceId: string, serviceId: string, writePrefix<span class="colonColor">: </span><span class="typeColor">string</span> <span class="let">=</span> <span class="string">"9999"</span>, readPrefix<span class="colonColor">: </span><span class="typeColor">string</span> <span class="let">=</span> <span class="string">"8888"</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>GetBLEDeviceCharacteristicsResponse</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">getBLEDeviceCharacteristics</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    deviceId,</code><code data-key='xmp'>    serviceId, //蓝牙特征值服务id</code><code data-key='xmp'>    success: <span class="let">async </span><span class="log">(</span>res<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="let">const </span><span class="log">{</span></code><code data-key='xmp'>                characteristics</code><code data-key='xmp'>            <span class="log">}</span> <span class="let">=</span> res;</code><code data-key='xmp'>            <span class="let">if </span><span class="log">(</span>characteristics <span class="let">&</span><span class="let">&</span> characteristics<span class="log">.</span><span class="title1">length</span><span class="let"> > </span>0<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                let writeCharacteristicId: string = "<span class="string">", readCharacteristicId: string = "</span>";</code><code data-key='xmp'>                <span class="let">for </span><span class="log">(</span><span class="let">let </span>characteristic <span class="let">of</span> characteristics<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                    <span class="let">if </span><span class="log">(</span>characteristic<span class="log">.</span><span class="title1">uuid</span><span class="log">.</span><span class="title1">substring</span><span class="log">(</span>4, 8<span class="log">)</span> <span class="let">===</span> writePrefix<span class="log">)</span> writeCharacteristicId <span class="let">=</span> characteristic<span class="log">.</span><span class="title1">uuid</span>;</code><code data-key='xmp'>                    <span class="let">if </span><span class="log">(</span>characteristic<span class="log">.</span><span class="title1">properties</span> <span class="let">&</span><span class="let">&</span> characteristic<span class="log">.</span><span class="title1">uuid</span><span class="log">.</span><span class="title1">substring</span><span class="log">(</span>4, 8<span class="log">)</span> <span class="let">===</span> readPrefix <span class="let">&</span><span class="let">&</span> <span class="log">(</span>characteristic<span class="log">.</span><span class="title1">properties</span><span class="log">.</span><span class="title1">notify</span><span class="let"> || </span>characteristic<span class="log">.</span><span class="title1">properties</span><span class="log">.</span><span class="title1">indicate</span><span class="log">)</span><span class="log">)</span> readCharacteristicId <span class="let">=</span> characteristic<span class="log">.</span><span class="title1">uuid</span>;</code><code data-key='xmp'>                    <span class="let">if </span><span class="log">(</span>writeCharacteristicId <span class="let">&</span><span class="let">&</span> readCharacteristicId<span class="log">)</span> <span class="let">return</span> <span class="title">resolve<span class="log">(</span></span><span class="log">{</span> writeCharacteristicId, readCharacteristicId <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>                <span class="log">}</span></code><code data-key='xmp'>            <span class="log">}</span></code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>        <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"获取特征值id失败"</span>, err<span class="colonColor">: </span><span class="typeColor">res <span class="log">}</span><span class="log">)</span></span>;</code><code data-key='xmp'>    <span class="log">}</span>,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"获取特征值id失败"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>writeByte <span class="let">=</span> <span class="log">(</span>deviceId: string, serviceId: string, characteristicId: string, direction: ArrayBuffer, maxMtu<span class="colonColor">: </span><span class="typeColor">number</span> <span class="let">=</span> 20<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">let </span>l<span class="colonColor">: </span><span class="typeColor">number</span> <span class="let">=</span> 0, len <span class="let">=</span> Math<span class="log">.</span><span class="title1">ceil</span><span class="log">(</span>direction<span class="log">.</span><span class="title1">byteLength</span> / maxMtu<span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">const </span>parallelTask <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> =></span><span class="let"> new </span>Promise<span class='angleBracket'>&lt;</span><span class='elName'>void</span><span class='angleBracket'>&gt;</span><span class="log">(</span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">writeBLECharacteristicValue</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>        deviceId, //蓝牙设备id</code><code data-key='xmp'>        serviceId, //蓝牙特征值服务id</code><code data-key='xmp'>        characteristicId, //蓝牙特征值写的uuid</code><code data-key='xmp'>        value: direction<span class="log">.</span><span class="title1">slice</span><span class="log">(</span>l * maxMtu, <span class="log">(</span>l <span class="let">+</span> 1<span class="log">)</span> * maxMtu<span class="log">)</span>,</code><code data-key='xmp'>        writeType: <span class="string">"write"</span>,</code><code data-key='xmp'>        success: <span class="let">async </span><span class="log">(</span>res<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>            <span class="let">if </span><span class="log">(</span><span class="let">!</span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span> <span class="title">reject<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>            <span class="let">if </span><span class="log">(</span>l <span class="let">+</span> 1<span class="let"> < </span>len<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                l<span class="let">+</span><span class="let">+</span>;</code><code data-key='xmp'>                try <span class="log">{</span></code><code data-key='xmp'>                    <span class="let">await </span><span class="title">parallelTask<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>                <span class="log">}</span> catch <span class="log">(</span>err<span class="colonColor">: </span><span class="typeColor">any</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                    <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"写入指令出现错误"</span>, err<span class="colonColor">: </span><span class="typeColor">res <span class="log">}</span><span class="log">)</span></span>;</code><code data-key='xmp'>                <span class="log">}</span></code><code data-key='xmp'>            <span class="log">}</span></code><code data-key='xmp'>            <span class="title">resolve<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span>,</code><code data-key='xmp'>        fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"写入指令出现错误"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">return</span> <span class="title">parallelTask<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>str2buffer <span class="let">=</span> <span class="log">(</span>str<span class="colonColor">: </span><span class="typeColor">string<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">const </span>buffer <span class="let">=</span><span class="let"> new </span><span class="title">Uint8Array<span class="log">(</span></span><span class="log">(</span>str<span class="log">.</span><span class="title1">match</span><span class="log">(</span>/[\da<span class="let">-</span>f]<span class="log">{</span>2<span class="log">}</span>/gi<span class="log">)</span><span class="let"> || </span>[]<span class="log">)</span><span class="log">.</span><span class="title1">map</span><span class="log">(</span><span class='let'>function</span> <span class="log">(</span>h<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        <span class="let">return</span> <span class="title">parseInt<span class="log">(</span></span>h, 16<span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">return</span> Array<span class="log">.</span><span class="title1">prototype</span><span class="log">.</span><span class="title1">slice</span><span class="log">.</span><span class="title1">call</span><span class="log">(</span><span class="let">new </span><span class="title">Uint8Array<span class="log">(</span></span>buffer<span class="log">.</span><span class="title1">buffer</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>notifyBLECharacteristicValueChange <span class="let">=</span> <span class="log">(</span>deviceId<span class="colonColor">: </span><span class="typeColor">string</span>, serviceId<span class="colonColor">: </span><span class="typeColor">string</span>, characteristicId<span class="colonColor">: </span><span class="typeColor">string</span><span class="log">)</span>:<span class="let"> Promise</span><span class='angleBracket'>&lt;</span><span class='elName'>void</span><span class='angleBracket'>&gt;</span><span class="log"> =></span><span class="let"> new </span><span class="title">Promise<span class="log">(</span></span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span>wx<span class="log">.</span><span class="title1">notifyBLECharacteristicValueChange</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>    characteristicId,</code><code data-key='xmp'>    deviceId,</code><code data-key='xmp'>    serviceId,</code><code data-key='xmp'>    state: <span class="let">true</span>,</code><code data-key='xmp'>    success<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>res<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>res<span class="log">.</span><span class="title1">errMsg</span><span class="log">.</span><span class="title1">includes</span><span class="log">(</span><span class="string">":ok"</span><span class="log">)</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="title">resolve<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="let"> else </span><span class="log">{</span></code><code data-key='xmp'>            <span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"监听返回值错误"</span>, err<span class="colonColor">: </span><span class="typeColor">res <span class="log">}</span><span class="log">)</span></span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span>,</code><code data-key='xmp'>    fail<span class="colonColor">: </span><span class="typeColor"><span class="log">(</span>err<span class="log">)</span></span><span class="log"> => </span><span class="title">reject<span class="log">(</span></span><span class="log">{</span> errMsg: <span class="string">"监听返回值错误"</span>, err <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>onBLECharacteristicValueChange <span class="let">=</span> <span class="log">(</span>successCb: Function, lockMacID<span class="colonColor">: </span><span class="typeColor">number<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">let </span>data<span class="colonColor">: </span><span class="typeColor">number[]</span> <span class="let">=</span> [], bytesLen <span class="let">=</span> 0, dir<span class="colonColor">: </span><span class="typeColor">string</span> <span class="let">=</span> "", timer<span class="colonColor">: </span><span class="typeColor">number</span> <span class="let">=</span> 0, success<span class="colonColor">: </span><span class="typeColor">boolean</span> <span class="let">=</span> <span class="let">false</span>;</code><code data-key='xmp'>    wx<span class="log">.</span><span class="title1">onBLECharacteristicValueChange</span><span class="log">(</span><span class="let">async </span>characteristic<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>        <span class="let">let </span>list <span class="let">=</span> Array<span class="log">.</span><span class="title1">prototype</span><span class="log">.</span><span class="title1">slice</span><span class="log">.</span><span class="title1">call</span><span class="log">(</span><span class="let">new </span><span class="title">Uint8Array<span class="log">(</span></span>characteristic<span class="log">.</span><span class="title1">value</span><span class="log">)</span><span class="log">)</span></code><code data-key='xmp'>        dir <span class="let">+</span><span class="let">=</span> list<span class="log">.</span><span class="title1">map</span><span class="log">(</span>str<span class="log"> => </span>str<span class="log">.</span><span class="title1">toString</span><span class="log">(</span>16<span class="log">)</span><span class="log">.</span><span class="title1">padStart</span><span class="log">(</span>2, <span class="string">"0"</span><span class="log">)</span><span class="log">)</span><span class="log">.</span><span class="title1">join</span><span class="log">(</span>""<span class="log">)</span>;</code><code data-key='xmp'>        data<span class="log">.</span><span class="title1">push</span><span class="log">(</span><span class="log">.</span><span class="log">.</span><span class="log">.</span>list<span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>bytesLen <span class="let">===</span> 0 <span class="let">&</span><span class="let">&</span> data[0] <span class="let">===</span> <span class="title">str2buffer<span class="log">(</span></span><span class="string">"FE"</span><span class="log">)</span>[0]<span class="log">)</span> bytesLen <span class="let">=</span> data[1];</code><code data-key='xmp'>        <span class="green">已经成功了来了新回执,一律往上推</span></code><code data-key='xmp'>        <span class="title">clearInterval<span class="log">(</span></span>timer<span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>success<span class="log">)</span> timer <span class="let">=</span> <span class="title">setTimeout<span class="log">(</span></span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="title">returnOrder<span class="log">(</span></span>lockMacID, dir<span class="log">)</span>, 500<span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">if </span><span class="log">(</span>data<span class="log">.</span><span class="title1">length</span> <span class="let">===</span> bytesLen <span class="let">&</span><span class="let">&</span> <span class="let">!</span>success<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            <span class="let">let </span>res <span class="let">=</span> data;</code><code data-key='xmp'>            data <span class="let">=</span> [], bytesLen <span class="let">=</span> 0;</code><code data-key='xmp'>            success <span class="let">=</span> <span class="let">await </span><span class="title">successCb<span class="log">(</span></span>res<span class="log">)</span>;</code><code data-key='xmp'>            <span class="log">(</span>success <span class="let">&</span><span class="let">&</span> <span class="title">returnOrder<span class="log">(</span></span>lockMacID, dir<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">let </span>deviceId<span class="colonColor">: </span><span class="typeColor">string</span> <span class="let">=</span> "";</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>resetDeviceId <span class="let">=</span> <span class="log">(</span><span class="log">)</span><span class="log"> => </span>deviceId <span class="let">=</span> "";</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>complete <span class="let">=</span> <span class="let">async </span><span class="log">(</span>title: string, modal<span class="colonColor">: </span><span class="typeColor">boolean</span> <span class="let">=</span> <span class="let">false</span>, cb?<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">await </span><span class="title">offBLEConnectionStateChange<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>deviceId<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        try <span class="log">{</span></code><code data-key='xmp'>            <span class="let">await </span><span class="title">closeBLEConnect<span class="log">(</span></span>deviceId<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span> catch <span class="log">(</span>err<span class="log">)</span> <span class="log">{</span> <span class="log">}</span></code><code data-key='xmp'>        deviceId <span class="let">=</span> "";</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="title">hideLoading<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>modal<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        <span class="title">showModal<span class="log">(</span></span><span class="string">"提示"</span>, title, <span class="let">true</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span><span class="let"> else </span><span class="log">{</span></code><code data-key='xmp'>        <span class="title">showToast<span class="log">(</span></span>title<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="log">(</span>cb <span class="let">&</span><span class="let">&</span> <span class="title">cb<span class="log">(</span></span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">interface </span>ConnectResponse <span class="log">{</span></code><code data-key='xmp'>    writeCharacteristicId: string,</code><code data-key='xmp'>    deviceId: string,</code><code data-key='xmp'>    serviceId: string</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>connectDevice <span class="let">=</span> <span class="log">(</span>bluetoothMac: string, disconnectCb?<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> =></span><span class="let"> new </span>Promise<span class='angleBracket'>&lt;</span><span class='elName'>ConnectResponse</span><span class='angleBracket'>&gt;</span><span class="log">(</span><span class="let">async </span><span class="log">(</span>resolve, reject<span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    try <span class="log">{</span></code><code data-key='xmp'>        <span class="title">showLoading<span class="log">(</span></span>bleDefaultTip<span class="log">.</span><span class="title1">searchTip</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">await </span><span class="title">getBluetoothAdapterState<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">let </span>device <span class="let">=</span> <span class="let">await </span><span class="title">startBluetoothDevicesDiscovery<span class="log">(</span></span>[], bluetoothMac<span class="log">)</span>;</code><code data-key='xmp'>        <span class="title">showLoading<span class="log">(</span></span>bleDefaultTip<span class="log">.</span><span class="title1">connectTip</span><span class="log">)</span>;</code><code data-key='xmp'>        deviceId <span class="let">=</span> <span class="let">await </span><span class="title">createBLEConnection<span class="log">(</span></span>device<span class="log">.</span><span class="title1">deviceId</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">let </span>serviceId <span class="let">=</span> <span class="let">await </span><span class="title">getBLEDeviceServices<span class="log">(</span></span>deviceId<span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">let </span><span class="log">{</span> writeCharacteristicId, readCharacteristicId <span class="log">}</span> <span class="let">=</span> <span class="let">await </span><span class="title">getBLEDeviceCharacteristics<span class="log">(</span></span>deviceId, serviceId<span class="log">)</span>;</code><code data-key='xmp'>        <span class="let">await </span><span class="title">notifyBLECharacteristicValueChange<span class="log">(</span></span>deviceId, serviceId, readCharacteristicId<span class="log">)</span>;</code><code data-key='xmp'>        <span class="title">watchBLEConnectState<span class="log">(</span></span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>            deviceId <span class="let">=</span> "";</code><code data-key='xmp'>            <span class="log">(</span>disconnectCb <span class="let">&</span><span class="let">&</span> <span class="title">disconnectCb<span class="log">(</span></span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="title">resolve<span class="log">(</span></span><span class="log">{</span></code><code data-key='xmp'>            writeCharacteristicId,</code><code data-key='xmp'>            deviceId,</code><code data-key='xmp'>            serviceId</code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span> catch <span class="log">(</span>err<span class="colonColor">: </span><span class="typeColor">any</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        <span class="title">reject<span class="log">(</span></span><span class="log">{</span></code><code data-key='xmp'>            errMsg: err?<span class="log">.</span>errMsg,</code><code data-key='xmp'>            modal: err?<span class="log">.</span>modal</code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>blueOpen <span class="let">=</span> <span class="let">async </span><span class="log">(</span>locationID: number, lockMacID: number, getOpenRecord<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>   <span class="let"> interface </span>DeviceMess <span class="log">{</span></code><code data-key='xmp'>        bluetoothMac: string,</code><code data-key='xmp'>        orderKey: string[]</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="title">showLoading<span class="log">(</span></span><span class="string">"加载中..."</span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">const </span>res <span class="let">=</span> <span class="let">await </span><span class="title">getDeviceMess<span class="log">(</span></span>lockMacID<span class="log">)</span>;</code><code data-key='xmp'>    <span class="title">hideLoading<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>res <span class="let">&</span><span class="let">&</span> res<span class="log">.</span><span class="title1">success</span> <span class="let">&</span><span class="let">&</span> res<span class="log">.</span><span class="title1">data</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        <span class="let">let </span>data<span class="colonColor">: </span><span class="typeColor">DeviceMess</span> <span class="let">=</span> res<span class="log">.</span><span class="title1">data</span><span class="let"> as </span>DeviceMess, timer <span class="let">=</span> 0, isReply <span class="let">=</span> <span class="let">false</span></code><code data-key='xmp'>        <span class="let">const </span>issuedComplete <span class="let">=</span> <span class="log">(</span>title: string, modal<span class="colonColor">: </span><span class="typeColor">boolean</span> <span class="let">=</span> <span class="let">false</span>, cb?<span class="colonColor">: </span><span class="typeColor">Function<span class="log">)</span></span><span class="log"> => </span><span class="title">complete<span class="log">(</span></span>title, modal, <span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>            <span class="title">clearInterval<span class="log">(</span></span>timer<span class="log">)</span>;</code><code data-key='xmp'>            <span class="log">(</span>cb <span class="let">&</span><span class="let">&</span> <span class="title">cb<span class="log">(</span></span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>        try <span class="log">{</span></code><code data-key='xmp'>            <span class="let">let </span>info <span class="let">=</span> <span class="let">await </span><span class="title">connectDevice<span class="log">(</span></span>data<span class="log">.</span><span class="title1">bluetoothMac</span>, <span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="title">issuedComplete<span class="log">(</span></span>bleDefaultTip<span class="log">.</span><span class="title1">disconnectTip</span><span class="log">)</span><span class="log">)</span>, <span class="log">{</span> writeCharacteristicId, deviceId, serviceId <span class="log">}</span> <span class="let">=</span> info;</code><code data-key='xmp'>            <span class="title">onBLECharacteristicValueChange<span class="log">(</span></span><span class="let">async </span><span class="log">(</span>data<span class="colonColor">: </span><span class="typeColor">number[]<span class="let"> | </span>string</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>                isReply <span class="let">=</span> <span class="let">true</span>;</code><code data-key='xmp'>                <span class="let">if </span><span class="log">(</span>data[2]<span class="log">.</span>toString<span class="log">(</span>16<span class="log">)</span> <span class="let">===</span> <span class="string">"66"</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>                    <span class="title">clearTimeout<span class="log">(</span></span>timer<span class="log">)</span>;</code><code data-key='xmp'>                    <span class="let">let </span>i <span class="let">=</span> 1 <span class="let">-</span> <span class="title">Number<span class="log">(</span></span>data[data<span class="log">.</span><span class="title1">length</span> <span class="let">-</span> 9] <span class="let">===</span> 0<span class="log">)</span></code><code data-key='xmp'>                    <span class="title">issuedComplete<span class="log">(</span></span>[<span class="string">"开门成功"</span>, <span class="string">"开门失败"</span>][i], <span class="let">false</span>, <span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>                        <span class="title">bleOpenDoorPost<span class="log">(</span></span>locationID, [19, 20][i]<span class="log">)</span>;</code><code data-key='xmp'>                        <span class="title">getOpenRecord<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>                    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>                    <span class="log">(</span><span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>                        <span class="let">await </span><span class="title">updatePeopleCache<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>                        <span class="title">getApp<span class="log">(</span></span><span class="log">)</span><span class="log">.</span><span class="title1">getRoomInfo</span><span class="log">(</span>locationID, <span class="let">false</span><span class="log">)</span>;</code><code data-key='xmp'>                    <span class="log">}</span><span class="log">)</span><span class="log">(</span><span class="log">)</span>;</code><code data-key='xmp'>                    <span class="let">return</span> <span class="let">true</span>;</code><code data-key='xmp'>                <span class="log">}</span></code><code data-key='xmp'>                <span class="let">return</span> <span class="let">false</span>;</code><code data-key='xmp'>            <span class="log">}</span>, lockMacID<span class="log">)</span>;</code><code data-key='xmp'>            <span class="title">showLoading<span class="log">(</span></span>bleDefaultTip<span class="log">.</span><span class="title1">issueDirTip</span><span class="log">)</span>;</code><code data-key='xmp'>            <span class="let">await </span><span class="title">writeByte<span class="log">(</span></span>deviceId, serviceId, writeCharacteristicId, <span class="title">dealOrderKey<span class="log">(</span></span>data<span class="log">.</span><span class="title1">orderKey</span><span class="log">)</span>[0]<span class="log">)</span>;</code><code data-key='xmp'>            timer <span class="let">=</span> <span class="title">setTimeout<span class="log">(</span></span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="let">!</span>isReply <span class="let">&</span><span class="let">&</span> <span class="title">issuedComplete<span class="log">(</span></span>bleDefaultTip<span class="log">.</span><span class="title1">deviceNotReplyTip</span><span class="log">)</span>, bleDefaultTip<span class="log">.</span><span class="title1">waitDeviceReplyTime</span><span class="log">)</span></code><code data-key='xmp'>        <span class="log">}</span> catch <span class="log">(</span>err<span class="colonColor">: </span><span class="typeColor">any</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>            console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>err<span class="log">)</span>;</code><code data-key='xmp'>            <span class="title">issuedComplete<span class="log">(</span></span>err<span class="log">.</span><span class="title1">errMsg</span><span class="let"> || </span><span class="string">"开门失败"</span>, <span class="let">!</span><span class="let">!</span>err?<span class="log">.</span>modal<span class="log">)</span>;</code><code data-key='xmp'>        <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export </span><span class="let">const </span>closeBle <span class="let">=</span> <span class="let">async </span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">await </span><span class="title">offBluetoothAdapterStateChange<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    <span class="let">await </span><span class="title">offBLEConnectionStateChange<span class="log">(</span></span><span class="log">)</span>;</code><code data-key='xmp'>    try <span class="log">{</span> <span class="let">await </span><span class="title">stopBluetoothDevicesDiscovery<span class="log">(</span></span><span class="log">)</span>; <span class="log">}</span> catch <span class="log">(</span>e<span class="colonColor">: </span><span class="typeColor">any</span><span class="log">)</span> <span class="log">{</span> <span class="log">}</span></code><code data-key='xmp'>    try <span class="log">{</span> <span class="let">await </span><span class="title">closeBluetoothAdapter<span class="log">(</span></span><span class="log">)</span>; <span class="log">}</span> catch <span class="log">(</span>err<span class="colonColor">: </span><span class="typeColor">any</span><span class="log">)</span> <span class="log">{</span> <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h3 id='微信sdk使用' class='ZF318731'>微信sdk使用</h3><p class="remind">先放着</p><h3 id='生命周期' class='GZ979062'>生命周期</h3><h4 id='应用生命周期' class='NH565244'>应用生命周期</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div></div><div class="codePre"><code data-key='xmp'>App<span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  <span class="title">onLaunch<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">小程序初始化加载，只执行一次</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onShow<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">小程序显示</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onReady<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">小程序加载完成</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onError<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">小程序脚本发生错误时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onPageNotFound<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">跳转页面不存在时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onUnhandleRejection<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">未处理的Promise reject</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onThemeChange<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">主题切换时</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><h4 id='页面生命周期' class='bY761052'>页面生命周期</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div></div><div class="codePre"><code data-key='xmp'>Page<span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  <span class="title">onLoad<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">页面开始加载</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onShow<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">页面显示</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onReady<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">页面渲染完成</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onHide<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">页面隐藏</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">onUnload<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">页面销毁</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div></div><div class="codePre"><code data-key='xmp'>pageLifetimes: <span class="log">{</span></code><code data-key='xmp'>  show: <span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件所在页面显示时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  hide: <span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件所在页面隐藏时</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'>lifetimes: <span class="log">{</span></code><code data-key='xmp'>  <span class="title">created<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件被创建时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">attached<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件进入节点树时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">ready<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件布局和渲染完成时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">error<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件出现错误时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">moved<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件被移动时</span></code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">detached<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">组件被销毁时</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h3 id='性能优化' class='DA464020'>性能优化</h3><h4 id='静态初始化缓存' class='LL088978'>静态初始化缓存</h4><p class="indent">通过设置页面的json文件中<span class="highlight">initialRenderingCache</span>属性值为<span class="highlight">static</span>即可，微信客户端会在首次加载时将页面缓存起来，再下一次开启时去缓存中拿对应的缓存在逻辑层前面渲染显示，但是不能交互</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div></div><div class="codePre"><code data-key='xmp'><span class="green">index<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"initialRenderingCache"</span>: <span class="string">"static"</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h4 id='动态初始化缓存' class='ZY444932'>动态初始化缓存</h4><p class="indent">和静态不一样的是<span class="highlight">initialRenderingCache</span>的值是<span class="highlight">dynamic</span>，还可以动态设置缓存数据,如下</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div></div><div class="codePre"><code data-key='xmp'><span class="green">index<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"initialRenderingCache"</span>: <span class="string">"dynamic"</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">index<span class="log">.</span><span class="title1">js</span></span></code><code data-key='xmp'>Page<span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  <span class="title">onReady<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">要在ready生命周期之后才设置</span></code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">setInitialRenderingCache</span><span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>      设置动态缓存数据的key,和data里面的一直: 值</code><code data-key='xmp'>    <span class="log">}</span><span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><h4 id='按需注入' class='IG099128'>按需注入</h4><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div></div><div class="codePre"><code data-key='xmp'>app<span class="log">.</span><span class="title1">json</span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"lazyCodeLoading"</span>: <span class="string">"requiredComponent"</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h4 id='普通分包' class='DM216025'>普通分包</h4><p class="indent">在app.json中配置<span class="highlight">subpackages</span>,共不超过20M即可</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div></div><div class="codePre"><code data-key='xmp'><span class="green">app<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"subpackages"</span>: [</code><code data-key='xmp'>    <span class="log">{</span></code><code data-key='xmp'>      <span class="string">"root"</span>: <span class="string">"分包的根目录名"</span>,</code><code data-key='xmp'>      <span class="string">"name"</span>: <span class="string">"包名,可选"</span>,</code><code data-key='xmp'>      <span class="string">"pages"</span>: [</code><code data-key='xmp'>         <span class="string">"页面,和主包一致"</span></code><code data-key='xmp'>      ]</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  ]</code><code data-key='xmp'><span class="log">}</span></code></div></pre><h4 id='独立分包' class='IN885227'>独立分包</h4><p class="indent">这个和普通分包就多了一个<span class="highlight">independent</span>属性,值为<span class="highlight">true</span>,这样和主包就可以分离，加载分包不会加载主包，同时也不能使用主包里面的东西了,比如getApp()会是undefined，如果在getApp中传入一个<span class="highlight">allowDefault</span>,值为<span class="highlight">true</span>,那加载主包时就会合并设置的值</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div></div><div class="codePre"><code data-key='xmp'><span class="green">app<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"subpackages"</span>: [</code><code data-key='xmp'>    <span class="log">{</span></code><code data-key='xmp'>      <span class="string">"root"</span>: <span class="string">"分包的根目录名"</span>,</code><code data-key='xmp'>      <span class="string">"name"</span>: <span class="string">"包名,可选"</span>,</code><code data-key='xmp'>      <span class="string">"pages"</span>: [</code><code data-key='xmp'>         <span class="string">"页面,和主包一致"</span></code><code data-key='xmp'>      ],</code><code data-key='xmp'>      <span class="string">"independent"</span>: <span class="string">"true"</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  ]</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">分包中调用</span></code><code data-key='xmp'><span class="let">let </span>instance <span class="let">=</span> <span class="title">getApp<span class="log">(</span></span><span class="log">{</span>allowDefault<span class="colonColor">: </span><span class="typeColor">true<span class="log">}</span></span><span class="log">)</span>;</code><code data-key='xmp'>instance<span class="log">.</span><span class="title1">globalData</span><span class="log">.</span><span class="title1">a</span> <span class="let">=</span> 1;</code><code data-key='xmp'><span class="green">等主包加载时就会在globalData里面有个a的属性</span></code></div></pre><h4 id='分包预加载' class='NG679924'>分包预加载</h4><p class="indent">通过配置app.json文件中的<span class="highlight">preloadRule</span>属性设置即可</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div></div><div class="codePre"><code data-key='xmp'><span class="green">app<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"preloadRule"</span>: <span class="log">{</span></code><code data-key='xmp'>    <span class="string">"admin/pages/index/index"</span>: <span class="log">{</span></code><code data-key='xmp'>      <span class="string">"network"</span>: <span class="string">"all"</span><span class="let"> | </span><span class="string">"wifi"</span>,</code><code data-key='xmp'>      <span class="string">"packages"</span>: [</code><code data-key='xmp'>         <span class="green">再加载index页面时预先加载哪些包</span></code><code data-key='xmp'>        <span class="string">"__APP__"</span>,<span class="green">主包的别名</span></code><code data-key='xmp'>      ]</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h4 id='占位组件' class='ND374082'>占位组件</h4><p class="indent">提前要开启按需注入，意思是在小程序启动时不回注入,用一个view或者其它组件占个位置,只有渲染时才注入,通过设置app.json中的<span class="highlight">componentPlaceholder</span>属性</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div></div><div class="codePre"><code data-key='xmp'><span class="green">index<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"usingComponents"</span>: <span class="log">{</span></code><code data-key='xmp'>      <span class="string">"自定义组件名"</span>: <span class="string">"路径"</span></code><code data-key='xmp'>   <span class="log">}</span>,</code><code data-key='xmp'>   <span class="string">"componentPlaceholder"</span>: <span class="log">{</span></code><code data-key='xmp'>      <span class="string">"要占位的组件名"</span>: <span class="string">"用什么占位"</span></code><code data-key='xmp'>   <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">然后在wxml中照常使用自定义组件</span></code></div></pre><h4 id='分包异步加载' class='aH668183'>分包异步加载</h4><p class="indent">通过require.sync加载其它包里面的数据</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div></div><div class="codePre"><code data-key='xmp'><span class="green">utils/util</span></code><code data-key='xmp'>module<span class="log">.</span><span class="title1">exports</span> <span class="let">=</span> <span class="log">{</span></code><code data-key='xmp'>  list: [</code><code data-key='xmp'>    <span class="string">"测试"</span></code><code data-key='xmp'>  ]</code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">index<span class="log">.</span><span class="title1">js</span></span></code><code data-key='xmp'><span class="log">(</span><span class="let">async </span><span class='let'>function</span> <span class="log">(</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>  <span class="let">const </span>res <span class="let">=</span> <span class="let">await </span>require<span class="log">.</span><span class="title1">async</span><span class="log">(</span><span class="string">"~/utils/util"</span><span class="log">)</span>;</code><code data-key='xmp'>  console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>res<span class="log">.</span><span class="title1">list</span><span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span><span class="log">(</span><span class="log">)</span></code><code data-key='xmp'><span class="green">还可以通过回调函数方式</span></code><code data-key='xmp'>require<span class="log">(</span><span class="string">"~/utils/util"</span>,res<span class="log"> => </span>console<span class="log">.</span><span class="title1">log</span><span class="log">(</span>res<span class="log">.</span><span class="title1">list</span><span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'><span class="green">通过requirePlugin<span class="log">.</span><span class="title1">async</span>也可导入插件</span></code></div></pre><h4 id='page-container' class='BA142135'>page-container</h4><p class="indent">用于弹窗使用，点返回键相当于关闭弹窗</p><p class="indent"><a href=''https://developers.weixin.qq.com/miniprogram/dev/component/page-container.html'' title=''page-container'' target="_black">官方文档</a></p><h3 id='日志反馈' class='Ma241166'>日志反馈</h3><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div style='height: 14px;'></div><div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div></div><div class="codePre"><code data-key='xmp'><span class="let">const </span>logManager <span class="let">=</span> wx<span class="log">.</span><span class="title1">RealtimeLogManager</span><span class="let"> ? </span>wx<span class="log">.</span><span class="title1">RealtimeLogManager</span><span class="log">(</span><span class="log">)</span> <span class="colonColor">: </span><span class="typeColor"><span class='keyword'>null</span></span>;</code><code data-key='xmp'> </code><code data-key='xmp'><span class="let">export default</span> <span class="log">{</span></code><code data-key='xmp'>  <span class="title">info<span class="log">(</span></span>args<span class="colonColor">: </span><span class="typeColor">any</span>,filterMsg?<span class="colonColor">: </span><span class="typeColor">string</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>     logManager?<span class="log">.</span>info?<span class="log">.</span>apply<span class="log">(</span>logManager, [JSON<span class="log">.</span><span class="title1">stringify</span><span class="log">(</span>args<span class="log">)</span>]<span class="log">)</span></code><code data-key='xmp'>     <span class="title"><span class="let">if</span><span class="log">(</span></span>filterMsg<span class="log">)</span><span class="let">this</span><span class="log">.</span><span class="title1">setFilterMsg</span><span class="log">(</span>filterMsg<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">warn<span class="log">(</span></span>args<span class="colonColor">: </span><span class="typeColor">any</span>,filterMsg?<span class="colonColor">: </span><span class="typeColor">string</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>     logManager?<span class="log">.</span>warn?<span class="log">.</span>apply<span class="log">(</span>logManager, [JSON<span class="log">.</span><span class="title1">stringify</span><span class="log">(</span>args<span class="log">)</span>]<span class="log">)</span>;</code><code data-key='xmp'>     <span class="title"><span class="let">if</span><span class="log">(</span></span>filterMsg<span class="log">)</span><span class="let">this</span><span class="log">.</span><span class="title1">setFilterMsg</span><span class="log">(</span>filterMsg<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">error<span class="log">(</span></span>args<span class="colonColor">: </span><span class="typeColor">any</span>,filterMsg?<span class="colonColor">: </span><span class="typeColor">string</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>     logManager?<span class="log">.</span>error?<span class="log">.</span>apply<span class="log">(</span>logManager, [JSON<span class="log">.</span><span class="title1">stringify</span><span class="log">(</span>args<span class="log">)</span>]<span class="log">)</span>;</code><code data-key='xmp'>     <span class="title"><span class="let">if</span><span class="log">(</span></span>filterMsg<span class="log">)</span><span class="let">this</span><span class="log">.</span><span class="title1">setFilterMsg</span><span class="log">(</span>filterMsg<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span>,</code><code data-key='xmp'>  <span class="title">setFilterMsg<span class="log">(</span></span>filterMsg<span class="colonColor">: </span><span class="typeColor">string</span><span class="log">)</span> <span class="log">{</span> <span class="green">从基础库2<span class="log">.</span><span class="title1">7</span><span class="log">.</span><span class="title1">3</span>开始支持</span></code><code data-key='xmp'>     logManager?<span class="log">.</span>setFilterMsg<span class="log">(</span>filterMsg<span class="log">)</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">通过引入再调用对应的日志方法，再通过setFilterMsg设置日志的筛选文本,可以在管理系统中筛选出该字段的日志</span></code><code data-key='xmp'><span class="green">微信公众平台 <span class="let">-</span>> 开发管理 <span class="let">-</span>> 运维中心就可以查看和查询</span></code></div></pre><h3 id='mobx-miniprogram全局状态管理' class='jF407719'>mobx-miniprogram全局状态管理</h3><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div></div><div class="codePre"><code data-key='xmp'><span class="green">下载包</span></code><code data-key='xmp'>npm i mobx<span class="let">-</span>miniprogram mobx<span class="let">-</span>miniprogram<span class="let">-</span>bindings <span class="let">-</span><span class="let">-</span>save<span class="let">-</span>dev</code><code data-key='xmp'><span class="green">引入</span></code><code data-key='xmp'><span class="let">import </span><span class="log">{</span>observable,action<span class="log">}</span><span class="let"> from </span><span class="string">"mobx-miniprogram"</span>;</code><code data-key='xmp'><span class="let">import </span><span class="log">{</span>BehaviorWithStore<span class="log">}</span><span class="let"> from </span><span class="string">"mobx-miniprogram-bindings"</span>;</code><code data-key='xmp'><span class="let">const </span>store <span class="let">=</span> <span class="title">observable<span class="log">(</span></span><span class="log">{</span></code><code data-key='xmp'>  counter: 0,</code><code data-key='xmp'>  setCounter: <span class="title">action<span class="log">(</span></span><span class='let'>function</span><span class="log">(</span>this<span class="colonColor">: </span><span class="typeColor">any</span>,counter<span class="colonColor">: </span><span class="typeColor">number</span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">counter</span> <span class="let">=</span> counter;</code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>,</code><code data-key='xmp'>behavior <span class="let">=</span> <span class="title">BehaviorWithStore<span class="log">(</span></span><span class="log">{</span></code><code data-key='xmp'>  fields: [<span class="string">"counter"</span>], <span class="green">需要导出的state</span></code><code data-key='xmp'>  actions: [<span class="string">"setCounter"</span>] <span class="green">需要使用到的action方法</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div></div><div class="codePre"><code data-key='xmp'><span class="green">在Page中使用</span></code><code data-key='xmp'><span class="let">import </span><span class="log">{</span>behavoir<span class="log">}</span><span class="let"> from </span><span class="string">"./store/index"</span>;</code><code data-key='xmp'>Page<span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  behaviors: [behavior],</code><code data-key='xmp'>  <span class="title">onLoad<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>    <span class="let">this</span><span class="log">.</span><span class="title1">setCounter</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">data</span><span class="log">.</span><span class="title1">counter</span> <span class="let">+</span> 1<span class="log">)</span>;</code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span></code></div></pre><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div></div><div class="codePre"><code data-key='xmp'><span class="green">在组件中使用</span></code><code data-key='xmp'><span class="let">import </span><span class="log">{</span>ComponentWithStore<span class="log">}</span><span class="let"> from </span><span class="string">"mobx-miniprogram-bindings"</span>;</code><code data-key='xmp'><span class="let">import </span><span class="log">{</span>store<span class="log">}</span><span class="let"> from </span><span class="string">"~/store/index.ts"</span>;</code><code data-key='xmp'>ComponentWithStore<span class="log">(</span><span class="log">{</span></code><code data-key='xmp'>  storeBindings: [</code><code data-key='xmp'>    <span class="log">{</span></code><code data-key='xmp'>      store,</code><code data-key='xmp'>      fields: [<span class="string">"counter"</span>],</code><code data-key='xmp'>      actions: [<span class="string">"setCounter"</span>]</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  ],</code><code data-key='xmp'>  lifetimes: <span class="log">{</span></code><code data-key='xmp'>    <span class="title">attached<span class="log">(</span></span><span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>      <span class="let">this</span><span class="log">.</span><span class="title1">setCounter</span><span class="log">(</span><span class="let">this</span><span class="log">.</span><span class="title1">data</span><span class="log">.</span><span class="title1">counter</span> <span class="let">+</span> 1<span class="log">)</span>;</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><h3 id='路径别名' class='bf152412'>路径别名</h3><h4 id='resolveAlias' class='XL436199'>resolveAlias</h4><p class="indent">在app.json文件中的resolveAlias配置对应的路径别名，如果是ts环境还需要在tsconfig.js文件中配置compilerOptions.paths属性</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div></div><div class="codePre"><code data-key='xmp'><span class="green">app<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"resolveAlias"</span>: <span class="log">{</span></code><code data-key='xmp'>    <span class="string">"~/*"</span>: <span class="string">"/*"</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">tsconfig<span class="log">.</span><span class="title1">js</span></span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"compilerOptions"</span>: <span class="log">{</span></code><code data-key='xmp'>    <span class="string">"paths"</span>: <span class="log">{</span></code><code data-key='xmp'>      <span class="string">"~/*"</span>: [<span class="string">"./miniprogram/*"</span>]</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre>
                </div>
                <div class="rightDraw">
                <div class="menu"><div class="directory">目录</div><ul class="menuCon"><li class="menu_li"><a href="#小程序" id="MD166106">小程序</a><ul class="menuCon_1"><li class="menu_li0"><a href="#获取openid" id="fF845416">获取openid</a></li><li class="menu_li1"><a href="#获取unionid" id="bG229311">获取unionid</a></li><li class="menu_li2"><a href="#nodejs解密代码" id="ei863044">nodejs解密代码</a></li></ul></li><li class="menu_li"><a href="#蓝牙设备连接" id="Zd356907" class="">蓝牙设备连接</a><ul class="menuCon_1"><li class="menu_li0"><a href="#openBluetoothAdapter" id="IE901870" class="">openBluetoothAdapter</a></li><li class="menu_li1"><a href="#closeBluetoothAdapter" id="Ma753513">closeBluetoothAdapter</a></li><li class="menu_li2"><a href="#onBluetoothAdapterStateChange" id="KL948909">onBluetoothAdapterStateChange</a></li><li class="menu_li3"><a href="#offBluetoothAdapterStateChange" id="GC070460">offBluetoothAdapterStateChange</a></li><li class="menu_li4"><a href="#getBluetoothAdapterState" id="fe910269">getBluetoothAdapterState</a></li><li class="menu_li5"><a href="#startBluetoothDevicesDiscovery" id="hh504022">startBluetoothDevicesDiscovery</a></li><li class="menu_li6"><a href="#getBluetoothDevices" id="FD848521">getBluetoothDevices</a></li><li class="menu_li7"><a href="#onBluetoothDeviceFound" id="Xc656730">onBluetoothDeviceFound</a></li><li class="menu_li8"><a href="#stopBluetoothDevicesDiscovery" id="hM963108">stopBluetoothDevicesDiscovery</a></li><li class="menu_li9"><a href="#createBLEConnection" id="hX628512">createBLEConnection</a></li><li class="menu_li10"><a href="#getBLEDeviceServices" id="iD089550">getBLEDeviceServices</a></li><li class="menu_li11"><a href="#getBELDeviceCharacteristics" id="CE006205">getBELDeviceCharacteristics</a></li><li class="menu_li12"><a href="#writeBLECharateristicValue" id="Fe118737">writeBLECharateristicValue</a></li><li class="menu_li13"><a href="#notifyBLECharacteristicValueChange" id="NK380030">notifyBLECharacteristicValueChange</a></li><li class="menu_li14"><a href="#onBLECharacteristicValueChange" id="Ff411503">onBLECharacteristicValueChange</a></li><li class="menu_li15"><a href="#进制转换" id="aI392419" class="">进制转换</a></li><li class="menu_li16"><a href="#字符串转换为buffer" id="iC851620">字符串转换为buffer</a></li><li class="menu_li17"><a href="#buffer转换成字符串" id="gb113559">buffer转换成字符串</a></li><li class="menu_li18"><a href="#案例" id="cM899952" class="">案例</a></li></ul></li><li class="menu_li"><a href="#微信sdk使用" id="ZF318731">微信sdk使用</a></li><li class="menu_li"><a href="#生命周期" id="GZ979062">生命周期</a><ul class="menuCon_1"><li class="menu_li0"><a href="#应用生命周期" id="NH565244">应用生命周期</a></li><li class="menu_li1"><a href="#页面生命周期" id="bY761052">页面生命周期</a></li></ul></li><li class="menu_li"><a href="#性能优化" id="DA464020">性能优化</a><ul class="menuCon_1"><li class="menu_li0"><a href="#静态初始化缓存" id="LL088978">静态初始化缓存</a></li><li class="menu_li1"><a href="#动态初始化缓存" id="ZY444932">动态初始化缓存</a></li><li class="menu_li2"><a href="#按需注入" id="IG099128">按需注入</a></li><li class="menu_li3"><a href="#普通分包" id="DM216025">普通分包</a></li><li class="menu_li4"><a href="#独立分包" id="IN885227">独立分包</a></li><li class="menu_li5"><a href="#分包预加载" id="NG679924">分包预加载</a></li><li class="menu_li6"><a href="#占位组件" id="ND374082">占位组件</a></li><li class="menu_li7"><a href="#分包异步加载" id="aH668183" class="">分包异步加载</a></li><li class="menu_li8"><a href="#page-container" id="BA142135">page-container</a></li></ul></li><li class="menu_li"><a href="#日志反馈" id="Ma241166">日志反馈</a></li><li class="menu_li"><a href="#mobx-miniprogram全局状态管理" id="jF407719" class="">mobx-miniprogram全局状态管理</a></li><li class="menu_li"><a href="#路径别名" id="bf152412">路径别名</a><ul class="menuCon_1"><li class="menu_li0"><a href="#resolveAlias" id="XL436199">resolveAlias</a></li></ul></li></ul></div>
                </div>
              </div>
           </div>
           <svg t="1648304059372" class="icon up" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3132" width="200" height="200"><path d="M832 64 192 64C121.6 64 64 121.6 64 192l0 640c0 70.4 57.6 128 128 128l640 0c70.4 0 128-57.6 128-128L960 192C960 121.6 902.4 64 832 64zM762.24 759.04c-12.8 12.8-33.28 12.8-45.44 0L513.92 560l-202.24 199.04c-12.8 12.8-33.28 12.8-45.44 0-12.8-12.8-12.8-32.64 0-45.44l224-220.16c6.4-6.4 15.36-9.6 24.32-8.96C522.88 483.84 531.2 487.04 538.24 493.44l224 220.16C775.04 726.4 775.04 746.24 762.24 759.04zM762.24 503.04c-12.8 12.8-33.28 12.8-45.44 0L513.92 304 311.68 503.04c-12.8 12.8-33.28 12.8-45.44 0-12.8-12.8-12.8-32.64 0-45.44l224-220.16c6.4-6.4 15.36-9.6 24.32-8.96C522.88 227.84 531.2 231.04 538.24 237.44l224 220.16C775.04 470.4 775.04 490.24 762.24 503.04z" p-id="3133" fill="#ffffff"></path></svg>
        </div>
        </body>
           <script>let titles = [{"title":"小程序","id":"小程序","index":3,"class":"MD166106","children":[{"title":"获取openid","id":"获取openid","index":4,"class":"fF845416"},{"title":"获取unionid","id":"获取unionid","index":4,"class":"bG229311"},{"title":"nodejs解密代码","id":"nodejs解密代码","index":4,"class":"ei863044"}]},{"title":"蓝牙设备连接","id":"蓝牙设备连接","index":3,"class":"Zd356907","children":[{"title":"openBluetoothAdapter","id":"openBluetoothAdapter","index":4,"class":"IE901870"},{"title":"closeBluetoothAdapter","id":"closeBluetoothAdapter","index":4,"class":"Ma753513"},{"title":"onBluetoothAdapterStateChange","id":"onBluetoothAdapterStateChange","index":4,"class":"KL948909"},{"title":"offBluetoothAdapterStateChange","id":"offBluetoothAdapterStateChange","index":4,"class":"GC070460"},{"title":"getBluetoothAdapterState","id":"getBluetoothAdapterState","index":4,"class":"fe910269"},{"title":"startBluetoothDevicesDiscovery","id":"startBluetoothDevicesDiscovery","index":4,"class":"hh504022"},{"title":"getBluetoothDevices","id":"getBluetoothDevices","index":4,"class":"FD848521"},{"title":"onBluetoothDeviceFound","id":"onBluetoothDeviceFound","index":4,"class":"Xc656730"},{"title":"stopBluetoothDevicesDiscovery","id":"stopBluetoothDevicesDiscovery","index":4,"class":"hM963108"},{"title":"createBLEConnection","id":"createBLEConnection","index":4,"class":"hX628512"},{"title":"getBLEDeviceServices","id":"getBLEDeviceServices","index":4,"class":"iD089550"},{"title":"getBELDeviceCharacteristics","id":"getBELDeviceCharacteristics","index":4,"class":"CE006205"},{"title":"writeBLECharateristicValue","id":"writeBLECharateristicValue","index":4,"class":"Fe118737"},{"title":"notifyBLECharacteristicValueChange","id":"notifyBLECharacteristicValueChange","index":4,"class":"NK380030"},{"title":"onBLECharacteristicValueChange","id":"onBLECharacteristicValueChange","index":4,"class":"Ff411503"},{"title":"进制转换","id":"进制转换","index":4,"class":"aI392419"},{"title":"字符串转换为buffer","id":"字符串转换为buffer","index":4,"class":"iC851620"},{"title":"buffer转换成字符串","id":"buffer转换成字符串","index":4,"class":"gb113559"},{"title":"案例","id":"案例","index":4,"class":"cM899952"}]},{"title":"微信sdk使用","id":"微信sdk使用","index":3,"class":"ZF318731"},{"title":"生命周期","id":"生命周期","index":3,"class":"GZ979062","children":[{"title":"应用生命周期","id":"应用生命周期","index":4,"class":"NH565244"},{"title":"页面生命周期","id":"页面生命周期","index":4,"class":"bY761052"}]},{"title":"性能优化","id":"性能优化","index":3,"class":"DA464020","children":[{"title":"静态初始化缓存","id":"静态初始化缓存","index":4,"class":"LL088978"},{"title":"动态初始化缓存","id":"动态初始化缓存","index":4,"class":"ZY444932"},{"title":"按需注入","id":"按需注入","index":4,"class":"IG099128"},{"title":"普通分包","id":"普通分包","index":4,"class":"DM216025"},{"title":"独立分包","id":"独立分包","index":4,"class":"IN885227"},{"title":"分包预加载","id":"分包预加载","index":4,"class":"NG679924"},{"title":"占位组件","id":"占位组件","index":4,"class":"ND374082"},{"title":"分包异步加载","id":"分包异步加载","index":4,"class":"aH668183"},{"title":"page-container","id":"page-container","index":4,"class":"BA142135"}]},{"title":"日志反馈","id":"日志反馈","index":3,"class":"Ma241166"},{"title":"mobx-miniprogram全局状态管理","id":"mobx-miniprogram全局状态管理","index":3,"class":"jF407719"},{"title":"路径别名","id":"路径别名","index":3,"class":"bf152412","children":[{"title":"resolveAlias","id":"resolveAlias","index":4,"class":"XL436199"}]}];</script>
           <script src="../index.js" type="text/javascript"></script>
           </html>
            