
        <!DOCTYPE html>
         <html lang="en">
         <head>
	     <meta charset="UTF-8">
         <meta name="keywords" content="vue3源码,博客,前端"/>
         <meta name="description" content="vue3源码解读"/>
         <!--<meta http-equiv="content-security-policy" content="default-src self"/>-->
	     <title>vue3源码</title>
        </head>
        <link rel="stylesheet" href="../main.css">
        <body>
        <div class="message_box"></div>
        <div class="content">
           <div id="view">
              <div>
                <div class="bs_content">
                   <h1 id='vue3源码' class='BH938648'>vue3源码</h1><h2 id='入口文件' class='Zh219495'>入口文件</h2><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div></div><div class="codePre"><code data-key='xmp'><span class="green">package<span class="log">.</span><span class="title1">json</span>文件</span></code><code data-key='xmp'><span class="log">{</span></code><code data-key='xmp'>  <span class="string">"script"</span>: <span class="log">{</span></code><code data-key='xmp'>    <span class="string">"dev"</span>: <span class="string">"node scripts/dev.js"</span>,</code><code data-key='xmp'>    <span class="string">"build"</span>: <span class="string">"node scripts/build.js"</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="green">执行npm run build会去package<span class="log">.</span><span class="title1">json</span>文件中的script属性中找到对应的命令执行</span></code><code data-key='xmp'><span class="green">run build就会执行根目录下的scripts/build<span class="log">.</span><span class="title1">js</span>文件</span></code><code data-key='xmp'><span class="green">run dev就会执行根目录下的scripts/dev<span class="log">.</span><span class="title1">js</span>文件</span></code></div></pre><h2 id='buildJs' class='Fg232935'>buildJs</h2><p class="remind">run</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div></div><div class="codePre"><code data-key='xmp'>run<span class="log">(</span><span class="log">)</span>; <span class="green">首先执行的就是run函数</span></code><code data-key='xmp'><span class="let">async </span><span class='let'>function</span> <span class="title">run<span class="log">(</span></span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>  <span class="green">这边其实还会判断有没有传需要构建的目录,有就构建这些,没有才构建全部</span></code><code data-key='xmp'>  <span class="let">await </span><span class="title">buildAll<span class="log">(</span></span>allTargets<span class="log">)</span>;</code><code data-key='xmp'>  <span class="title">checkAllSizes<span class="log">(</span></span>allTargets<span class="log">)</span>;</code><code data-key='xmp'><span class="log">}</span></code></div></pre><p class="remind">allTargets获取</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div></div><div class="codePre"><code data-key='xmp'><span class="green">先读取packages目录下的所有文件或者文件夹名称出来</span></code><code data-key='xmp'><span class="let">const </span>allTargets <span class="let">=</span> fs<span class="log">.</span><span class="title1">readdirSync</span><span class="log">(</span>'packages'<span class="log">)</span><span class="log">.</span><span class="title1">filter</span><span class="log">(</span>f<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>  <span class="green">过滤掉文件</span></code><code data-key='xmp'>  <span class="let">if </span><span class="log">(</span><span class="let">!</span>fs<span class="log">.</span><span class="title1">statSync</span><span class="log">(</span>`packages/$<span class="log">{</span>f<span class="log">}</span>`<span class="log">)</span><span class="log">.</span><span class="title1">isDirectory</span><span class="log">(</span><span class="log">)</span><span class="log">)</span> <span class="let">return</span> <span class="let">false</span>；</code><code data-key='xmp'>  <span class="let">const </span>pkg <span class="let">=</span> <span class="title">require<span class="log">(</span></span>`<span class="log">.</span><span class="log">.</span>/packages/$<span class="log">{</span>f<span class="log">}</span>/package<span class="log">.</span><span class="title1">json</span>`<span class="log">)</span>； <span class="green">获取f文件夹下的package<span class="log">.</span><span class="title1">json</span>配置</span></code><code data-key='xmp'> <span class="green">这个文件夹下面package<span class="log">.</span><span class="title1">json</span>中有private有值或者没有buildOptions属性过滤掉</span></code><code data-key='xmp'>  <span class="let">if </span><span class="log">(</span>pkg<span class="log">.</span><span class="title1">private</span> <span class="let">&</span><span class="let">&</span> <span class="let">!</span>pkg<span class="log">.</span><span class="title1">buildOptions</span><span class="log">)</span> <span class="let">return</span> <span class="let">false</span>；</code><code data-key='xmp'>  <span class="let">return</span> <span class="let">true</span>；</code><code data-key='xmp'><span class="log">}</span><span class="log">)</span>;</code></div></pre><p class="remind">buildAll</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div></div><div class="codePre"><code data-key='xmp'><span class="let">async </span><span class='let'>function</span> <span class="title">buildAll<span class="log">(</span></span>targets<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>  <span class="let">await </span><span class="title">runParallel<span class="log">(</span></span>require<span class="log">(</span>'os'<span class="log">)</span><span class="log">.</span><span class="title1">cpus</span><span class="log">(</span><span class="log">)</span><span class="log">.</span><span class="title1">length</span>, targets, build<span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><p class="remind">runParallel</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div></div><div class="codePre"><code data-key='xmp'><span class="green">/**</span></code><code data-key='xmp'> <span class="green">* maxConcurrency 电脑的cpu数量</span></code><code data-key='xmp'> <span class="green">* source 构建的文件夹列表</span></code><code data-key='xmp'> <span class="green">* iteratorFn 构建函数</span></code><code data-key='xmp'><span class="green">**/</span></code><code data-key='xmp'><span class="let">async </span><span class='let'>function</span> <span class="title">runParallel<span class="log">(</span></span>maxConcurrency, source, iteratorFn<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>  <span class="let">const </span>ret <span class="let">=</span> [],executing <span class="let">=</span> []；</code><code data-key='xmp'>  <span class="let">for </span><span class="log">(</span><span class="let">const </span>item <span class="let">of</span> source<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>    <span class="let">const </span>p <span class="let">=</span><span class="let"> Promise</span><span class="log">.</span><span class="title1">resolve</span><span class="log">(</span><span class="log">)</span><span class="log">.</span><span class="title1">then</span><span class="log">(</span><span class="log">(</span><span class="log">)</span><span class="log"> => </span><span class="title">iteratorFn<span class="log">(</span></span>item, source<span class="log">)</span><span class="log">)</span></code><code data-key='xmp'>    ret<span class="log">.</span><span class="title1">push</span><span class="log">(</span>p<span class="log">)</span>；</code><code data-key='xmp'>    <span class="green">cpu数量小于需要构建目录的数量，大于就没必要关心了</span></code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>maxConcurrency<span class="let"> <= </span>source<span class="log">.</span><span class="title1">length</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>      <span class="let">const </span>e <span class="let">=</span> p<span class="log">.</span><span class="title1">then</span><span class="log">(</span><span class="log">(</span><span class="log">)</span><span class="log"> => </span>executing<span class="log">.</span><span class="title1">splice</span><span class="log">(</span>executing<span class="log">.</span><span class="title1">indexOf</span><span class="log">(</span>e<span class="log">)</span>, 1<span class="log">)</span><span class="log">)</span><span class="green">构建完成,将其移出未完成列表</span></code><code data-key='xmp'>      executing<span class="log">.</span><span class="title1">push</span><span class="log">(</span>e<span class="log">)</span> <span class="green">装进未完成列表</span></code><code data-key='xmp'>      <span class="let">if </span><span class="log">(</span>executing<span class="log">.</span><span class="title1">length</span><span class="let"> >= </span>maxConcurrency<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>        <span class="green">当前正在运行的数量超过了最大cpu数,等待完成一个之后再去继续构建新的</span></code><code data-key='xmp'>        <span class="let">await </span>Promise<span class="log">.</span><span class="title1">race</span><span class="log">(</span>executing<span class="log">)</span></code><code data-key='xmp'>      <span class="log">}</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span></code><code data-key='xmp'>  <span class="green">将最后构建结果返回</span></code><code data-key='xmp'>  <span class="let">return</span><span class="let"> Promise</span><span class="log">.</span><span class="title1">all</span><span class="log">(</span>ret<span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><p class="remind">build</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div style='height: 14px;'></div><div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div></div><div class="codePre"><code data-key='xmp'><span class="let">async </span><span class='let'>function</span> <span class="title">build<span class="log">(</span></span>target<span class="log">)</span><span class="log">{</span></code><code data-key='xmp'>  <span class="let">const </span>pkgDir <span class="let">=</span> path<span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>`packages/$<span class="log">{</span>target<span class="log">}</span>`<span class="log">)</span> <span class="green">获取绝对路径,</span></code><code data-key='xmp'>     pkg <span class="let">=</span> <span class="title">require<span class="log">(</span></span>`$<span class="log">{</span>pkgDir<span class="log">}</span>/package<span class="log">.</span><span class="title1">json</span>`<span class="log">)</span>, <span class="green">获取配置文件</span></code><code data-key='xmp'>     env <span class="let">=</span> <span class="log">(</span>pkg<span class="log">.</span><span class="title1">buildOptions</span> <span class="let">&</span><span class="let">&</span> pkg<span class="log">.</span><span class="title1">buildOptions</span><span class="log">.</span><span class="title1">env</span><span class="log">)</span><span class="let"> || </span>'production'; <span class="green">配置了的就用配置的,没有就生产模式</span></code><code data-key='xmp'>  <span class="let">await </span><span class="title">execa<span class="log">(</span></span></code><code data-key='xmp'>    'rollup',</code><code data-key='xmp'>    [</code><code data-key='xmp'>      `TARGET:$<span class="log">{</span>target<span class="log">}</span>`,<span class="green">构建文件夹名称</span></code><code data-key='xmp'>      <span class="log">.</span><span class="log">.</span><span class="log">.</span> <span class="green">环境变量</span></code><code data-key='xmp'>    ],</code><code data-key='xmp'>    <span class="log">{</span> stdio: 'inherit' <span class="log">}</span></code><code data-key='xmp'>  <span class="log">)</span>; <span class="green">终端执行rollup会执行项目根目录的rollup<span class="log">.</span><span class="title1">config</span><span class="log">.</span><span class="title1">js</span>文件</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre><h2 id='rollupConfigJs' class='DN232456'>rollupConfigJs</h2><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div style='height: 14px;'></div><div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div><div class='index'>29.</div><div class='index'>30.</div></div><div class="codePre"><code data-key='xmp'><span class="let">const </span>packagesDir <span class="let">=</span> path<span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>__dirname, 'packages'<span class="log">)</span> <span class="green">构建目录</span></code><code data-key='xmp'><span class="let">const </span>packageDir <span class="let">=</span> path<span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>packagesDir, process<span class="log">.</span><span class="title1">env</span><span class="log">.</span><span class="title1">TARGET</span><span class="log">)</span> <span class="green">build中传过来的环境变量,就是构建的文件夹名</span></code><code data-key='xmp'><span class="let">const </span>resolve <span class="let">=</span> p<span class="log"> => </span>path<span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>packageDir, p<span class="log">)</span></code><code data-key='xmp'><span class="let">const </span>pkg <span class="let">=</span> <span class="title">require<span class="log">(</span></span>resolve<span class="log">(</span>`package<span class="log">.</span><span class="title1">json</span>`<span class="log">)</span><span class="log">)</span> <span class="green">获取TARGET目录下的package<span class="log">.</span><span class="title1">json</span></span></code><code data-key='xmp'><span class="let">const </span>packageOptions <span class="let">=</span> pkg<span class="log">.</span><span class="title1">buildOptions</span><span class="let"> || </span><span class="log">{</span><span class="log">}</span> <span class="green">获取配置参数</span></code><code data-key='xmp'><span class="let">const </span>name <span class="let">=</span> packageOptions<span class="log">.</span><span class="title1">filename</span><span class="let"> || </span>path<span class="log">.</span><span class="title1">basename</span><span class="log">(</span>packageDir<span class="log">)</span> <span class="green">获取配置参数的filename或者就截取文件名</span></code><code data-key='xmp'><span class="let">const </span>outputConfigs <span class="let">=</span> <span class="log">{</span></code><code data-key='xmp'>  <span class="green">formats对应的配置</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">const </span>packageFormats <span class="let">=</span> process<span class="log">.</span><span class="title1">env</span><span class="log">.</span><span class="title1">FORMATS</span> <span class="let">&</span><span class="let">&</span> process<span class="log">.</span><span class="title1">env</span><span class="log">.</span><span class="title1">FORMATS</span><span class="log">.</span><span class="title1">split</span><span class="log">(</span>','<span class="log">)</span><span class="let">  || </span>packageOptions<span class="log">.</span><span class="title1">formats</span><span class="let"> || </span>['esm<span class="let">-</span>bundler', 'cjs']; <span class="green">rollup</span></code><code data-key='xmp'><span class="let">const </span>packageConfigs <span class="let">=</span> packageFormats<span class="log">.</span><span class="title1">map</span><span class="log">(</span>format<span class="log"> => </span><span class="title">createConfig<span class="log">(</span></span>format, outputConfigs[format]<span class="log">)</span><span class="log">)</span>;</code><code data-key='xmp'> </code><code data-key='xmp'><span class="green">生产模式</span></code><code data-key='xmp'><span class="let">if </span><span class="log">(</span>process<span class="log">.</span><span class="title1">env</span><span class="log">.</span><span class="title1">NODE_ENV</span> <span class="let">===</span> 'production'<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>  packageFormats<span class="log">.</span><span class="title1">forEach</span><span class="log">(</span>format<span class="log"> => </span><span class="log">{</span></code><code data-key='xmp'>    <span class="green">package<span class="log">.</span><span class="title1">json</span>配置了prod 直接过掉l</span></code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>packageOptions<span class="log">.</span><span class="title1">prod</span> <span class="let">===</span> <span class="let">false</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>      return</code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="green">生成个带<span class="log">.</span>pro<span class="log">.</span><span class="title1">js</span>的格式</span></code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>format <span class="let">===</span> 'cjs'<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>      packageConfigs<span class="log">.</span><span class="title1">push</span><span class="log">(</span>createProductionConfig<span class="log">(</span>format<span class="log">)</span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>    <span class="green">压缩</span></code><code data-key='xmp'>    <span class="let">if </span><span class="log">(</span>/^<span class="log">(</span>global<span class="let">|</span>esm<span class="let">-</span>browser<span class="log">)</span><span class="log">(</span><span class="let">-</span>runtime<span class="log">)</span>?/<span class="log">.</span>test<span class="log">(</span>format<span class="log">)</span><span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>      packageConfigs<span class="log">.</span><span class="title1">push</span><span class="log">(</span>createMinifiedConfig<span class="log">(</span>format<span class="log">)</span><span class="log">)</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code><code data-key='xmp'><span class="let">export default</span> packageConfigs;</code></div></pre><p class="remind">createConfig</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div><div class='index'>12.</div><div class='index'>13.</div><div class='index'>14.</div><div class='index'>15.</div><div class='index'>16.</div><div class='index'>17.</div><div class='index'>18.</div><div class='index'>19.</div><div class='index'>20.</div><div class='index'>21.</div><div class='index'>22.</div><div class='index'>23.</div><div class='index'>24.</div><div class='index'>25.</div><div class='index'>26.</div><div class='index'>27.</div><div class='index'>28.</div><div class='index'>29.</div><div class='index'>30.</div><div class='index'>31.</div><div class='index'>32.</div><div class='index'>33.</div><div class='index'>34.</div><div class='index'>35.</div><div class='index'>36.</div><div class='index'>37.</div><div class='index'>38.</div></div><div class="codePre"><code data-key='xmp'><span class="let">let </span>hasTSChecked <span class="let">=</span> <span class="let">false</span>; <span class="green">这个只需要开启一次</span></code><code data-key='xmp'><span class='let'>function</span> <span class="title">createConfig<span class="log">(</span></span>format, output, plugins <span class="let">=</span> []<span class="log">)</span> <span class="log">{</span></code><code data-key='xmp'>  output<span class="log">.</span><span class="title1">exports</span> <span class="let">=</span> isCompatPackage<span class="let"> ? </span>'auto'<span class="let"> : </span>'named'</code><code data-key='xmp'>  output<span class="log">.</span><span class="title1">sourcemap</span> <span class="let">=</span> <span class="let">!</span><span class="let">!</span>process<span class="log">.</span><span class="title1">env</span><span class="log">.</span><span class="title1">SOURCE_MAP</span></code><code data-key='xmp'>  <span class="let">const </span>tsPlugin <span class="let">=</span> <span class="title">ts<span class="log">(</span></span><span class="log">{</span></code><code data-key='xmp'>    check<span class="colonColor">: </span><span class="typeColor">process<span class="log">.</span><span class="title1">env</span><span class="log">.</span><span class="title1">NODE_ENV</span></span> <span class="let">===</span> 'production' <span class="let">&</span><span class="let">&</span> <span class="let">!</span>hasTSChecked,</code><code data-key='xmp'>    tsconfig: path<span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>__dirname, 'tsconfig<span class="log">.</span><span class="title1">json</span>'<span class="log">)</span>, <span class="green">配置tsconfig路径</span></code><code data-key='xmp'>    cacheRoot: path<span class="log">.</span><span class="title1">resolve</span><span class="log">(</span>__dirname, 'node_modules/<span class="log">.</span>rts2_cache'<span class="log">)</span>, <span class="green">配置缓存目录</span></code><code data-key='xmp'>    tsconfigOverride: <span class="log">{</span> <span class="green">覆盖tsconfig文件下面的一些属性</span></code><code data-key='xmp'>      compilerOptions: <span class="log">{</span></code><code data-key='xmp'>        target: isServerRenderer<span class="let"> || </span>isNodeBuild<span class="let"> ? </span>'es2019'<span class="let"> : </span>'es2015', <span class="green">服务端渲染就19 否则15</span></code><code data-key='xmp'>        sourceMap: output<span class="log">.</span><span class="title1">sourcemap</span>,</code><code data-key='xmp'>        declaration: shouldEmitDeclarations,<span class="green">生成对应的<span class="log">.</span>d<span class="log">.</span><span class="title1">ts</span>文件</span></code><code data-key='xmp'>        declarationMap: shouldEmitDeclarations<span class="green">声明文件生成sourceMap</span></code><code data-key='xmp'>      <span class="log">}</span>,</code><code data-key='xmp'>      exclude: ['**/__tests__', 'test<span class="let">-</span>dts']<span class="green">去除校验测试文件</span></code><code data-key='xmp'>    <span class="log">}</span></code><code data-key='xmp'>  <span class="log">}</span><span class="log">)</span>；</code><code data-key='xmp'>  hasTSChecked <span class="let">=</span> <span class="let">true</span>; <span class="green">编译后面的就不用再开启了</span></code><code data-key='xmp'>  <span class="let">let </span>entryFile <span class="let">=</span> /runtime$/<span class="log">.</span>test<span class="log">(</span>format<span class="log">)</span><span class="let"> ? </span>'src/runtime<span class="log">.</span><span class="title1">ts</span>' :'src/index<span class="log">.</span><span class="title1">ts</span>', <span class="green">入口文件名</span></code><code data-key='xmp'>     external <span class="let">=</span> [</code><code data-key='xmp'>       <span class="log">.</span><span class="log">.</span><span class="log">.</span>Object<span class="log">.</span><span class="title1">keys</span><span class="log">(</span>pkg<span class="log">.</span><span class="title1">dependencies</span><span class="let"> || </span><span class="log">{</span><span class="log">}</span><span class="log">)</span>,</code><code data-key='xmp'>       <span class="log">.</span><span class="log">.</span><span class="log">.</span>Object<span class="log">.</span><span class="title1">keys</span><span class="log">(</span>pkg<span class="log">.</span><span class="title1">peerDependencies</span><span class="let"> || </span><span class="log">{</span><span class="log">}</span><span class="log">)</span>,</code><code data-key='xmp'>       <span class="log">.</span><span class="log">.</span><span class="log">.</span>['path', 'url', 'stream']部的模块</code><code data-key='xmp'>     ]; <span class="green">需要保留在 bundle 外</span></code><code data-key='xmp'>  <span class="let">return</span> <span class="log">{</span></code><code data-key='xmp'>    input: <span class="title">resolve<span class="log">(</span></span>entryFile<span class="log">)</span>,</code><code data-key='xmp'>    external: [], <span class="green">需要保留在 bundle 外部的模块</span></code><code data-key='xmp'>    plugins: [</code><code data-key='xmp'>      <span class="green">json <span class="let">-</span>> 将json转换为es模块</span></code><code data-key='xmp'>      <span class="green">tsPlugin <span class="let">-</span>> ts编译转化</span></code><code data-key='xmp'>      <span class="green">createReplacePlugin <span class="let">-</span>> 一堆编译时需要用到的环境变量</span></code><code data-key='xmp'>      <span class="green">nodePlugins <span class="let">-</span>> node开发下一些兼容性插件</span></code><code data-key='xmp'>      <span class="green">plugins <span class="let">-</span>> 单独构建需要使用到的插件通过参数传递过来</span></code><code data-key='xmp'>    ], <span class="green">插件</span></code><code data-key='xmp'>    output, <span class="green">输出 </span></code><code data-key='xmp'>  <span class="log">}</span>；</code><code data-key='xmp'><span class="log">}</span></code></div></pre><h2 id='compiler-core' class='ZL374726'>compiler-core</h2><h3 id='compile.ts' class='YH812075'>compile.ts</h3><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div></div><div class="codePre"><code data-key='xmp'><span class="let">export </span><span class='let'>function</span> <span class="title">baseCompile<span class="log">(</span></span>template: string,options<span class="colonColor">: </span><span class="typeColor">CompilerOptions</span> <span class="let">=</span> <span class="log">{</span><span class="log">}</span><span class="log">)</span>: CodegenResult <span class="log">{</span></code><code data-key='xmp'>  <span class="let">const </span>ast <span class="let">=</span> <span class="title">isString<span class="log">(</span></span>template<span class="log">)</span><span class="let"> ? </span><span class="title">baseParse<span class="log">(</span></span>template, options<span class="log">)</span><span class="let"> : </span>template</code><code data-key='xmp'><span class="log">}</span></code></div></pre><p class="remind">baseParse</p><pre class='code' data-key='pre'>
                        <div class="code_header">
                          <div class="circle">
                           <div class="circle1"></div>
                           <div class="circle2"></div>
                           <div class="circle3"></div>
                          </div>
                          <svg title="复制" t="1649216860822" class="copy_code icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3280" width="24" height="24"><path d="M441.47 537.05h186.18v59.22H441.47zM441.47 671.04h280.56v59.22H441.47z" p-id="3281"></path><path d="M685.92 217.95c-0.62-0.65-1.27-1.25-1.93-1.84l-6.85-7.18h-9.52a29.56 29.56 0 0 0-6.31 0h-59.93l1.81-1.73-86.3-90.62H221.06a60.21 60.21 0 0 0-60.15 60.15V742.1a60.21 60.21 0 0 0 60.15 60.15h100.11v32.2a60.21 60.21 0 0 0 60.15 60.15h440.82a60.21 60.21 0 0 0 60.15-60.15V424L746.8 282z m93.95 184.69l-92.81-4.54a0.85 0.85 0 0 1-0.6-0.93l4.25-88.22 12.61 13.22zM221.06 743a1 1 0 0 1-0.93-0.93V176.73a1 1 0 0 1 0.93-0.93h270.45l31.55 33.13H381.32a60.21 60.21 0 0 0-60.15 60.15V743z m601.09 92.35H381.32a1 1 0 0 1-0.93-0.93V269.08a1 1 0 0 1 0.93-0.93h252.07l-6.08 126.27v0.12c-1.46 33.12 24.17 61.25 57 62.71L823.07 464v370.45a1 1 0 0 1-0.93 0.93z" p-id="3282"></path></svg>
                        </div>
                        <div class='indexPre'><div class='index'>1.</div><div class='index'>2.</div><div class='index'>3.</div><div class='index'>4.</div><div class='index'>5.</div><div class='index'>6.</div><div class='index'>7.</div><div class='index'>8.</div><div class='index'>9.</div><div class='index'>10.</div><div class='index'>11.</div></div><div class="codePre"><code data-key='xmp'><span class="let">export </span><span class='let'>function</span> <span class="title">baseParse<span class="log">(</span></span></code><code data-key='xmp'>  content: string,</code><code data-key='xmp'>  options<span class="colonColor">: </span><span class="typeColor">ParserOptions</span> <span class="let">=</span> <span class="log">{</span><span class="log">}</span></code><code data-key='xmp'><span class="log">)</span>: RootNode <span class="log">{</span></code><code data-key='xmp'>  <span class="let">const </span>context <span class="let">=</span> <span class="title">createParserContext<span class="log">(</span></span>content, options<span class="log">)</span></code><code data-key='xmp'>  <span class="let">const </span>start <span class="let">=</span> <span class="title">getCursor<span class="log">(</span></span>context<span class="log">)</span></code><code data-key='xmp'>  <span class="let">return</span> <span class="title">createRoot<span class="log">(</span></span></code><code data-key='xmp'>    <span class="title">parseChildren<span class="log">(</span></span>context, TextModes<span class="log">.</span><span class="title1">DATA</span>, []<span class="log">)</span>,</code><code data-key='xmp'>    <span class="title">getSelection<span class="log">(</span></span>context, start<span class="log">)</span></code><code data-key='xmp'>  <span class="log">)</span></code><code data-key='xmp'><span class="log">}</span></code></div></pre>
                </div>
                <div class="rightDraw">
                <div class="menu"><div class="directory">目录</div><ul class="menuCon"><li class="menu_li"><a href="#vue3源码" id="BH938648" class="">vue3源码</a><ul class="menuCon_1"><li class="menu_li0"><a href="#入口文件" id="Zh219495">入口文件</a></li><li class="menu_li1"><a href="#buildJs" id="Fg232935">buildJs</a></li><li class="menu_li2"><a href="#rollupConfigJs" id="DN232456">rollupConfigJs</a></li><li class="menu_li3"><a href="#compiler-core" id="ZL374726">compiler-core</a><ul class="menuCon_2"><li class="menu_li0"><a href="#compile.ts" id="YH812075">compile.ts</a></li></ul></li></ul></li></ul></div>
                </div>
              </div>
           </div>
           <svg t="1648304059372" class="icon up" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3132" width="200" height="200"><path d="M832 64 192 64C121.6 64 64 121.6 64 192l0 640c0 70.4 57.6 128 128 128l640 0c70.4 0 128-57.6 128-128L960 192C960 121.6 902.4 64 832 64zM762.24 759.04c-12.8 12.8-33.28 12.8-45.44 0L513.92 560l-202.24 199.04c-12.8 12.8-33.28 12.8-45.44 0-12.8-12.8-12.8-32.64 0-45.44l224-220.16c6.4-6.4 15.36-9.6 24.32-8.96C522.88 483.84 531.2 487.04 538.24 493.44l224 220.16C775.04 726.4 775.04 746.24 762.24 759.04zM762.24 503.04c-12.8 12.8-33.28 12.8-45.44 0L513.92 304 311.68 503.04c-12.8 12.8-33.28 12.8-45.44 0-12.8-12.8-12.8-32.64 0-45.44l224-220.16c6.4-6.4 15.36-9.6 24.32-8.96C522.88 227.84 531.2 231.04 538.24 237.44l224 220.16C775.04 470.4 775.04 490.24 762.24 503.04z" p-id="3133" fill="#ffffff"></path></svg>
        </div>
        </body>
           <script>let titles = [{"title":"vue3源码","id":"vue3源码","index":1,"class":"BH938648","children":[{"title":"入口文件","id":"入口文件","index":2,"class":"Zh219495"},{"title":"buildJs","id":"buildJs","index":2,"class":"Fg232935"},{"title":"rollupConfigJs","id":"rollupConfigJs","index":2,"class":"DN232456"},{"title":"compiler-core","id":"compiler-core","index":2,"class":"ZL374726","children":[{"title":"compile.ts","id":"compile.ts","index":3,"class":"YH812075"}]}]}];</script>
           <script src="../index.js" type="text/javascript"></script>
           </html>
            